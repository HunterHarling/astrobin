{% extends 'base.html' %}
{% load i18n %}
{% load tags %}

{% block content %}
    <div id="image-detail">
        <div id="main-content">
            <ul class="bar">
                <li id="menu">
                    <ul class="topnav">
                        <li id="actions" class="first">
                            <span class="text"><a href="#">{% trans "Actions" %}</a></span>
                            <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                            <div class="sub">
                                <ul class="subnav">
                                {% if request.user == image.user %}
                                    <li class="first bg-icon icon-edit">
                                        <span class="text"><a href="{% url image_edit_basic image.id %}">{% trans "Edit basic information" %}</a></span>
                                    </li>
                                    <li class="bg-icon icon-edit-gear">
                                        <span class="text"><a href="{% url image_edit_gear image.id %}">{% trans "Edit gear used" %}</a></span>
                                    </li>
                                    <li class="bg-icon icon-edit-acquisition">
                                        <span class="text"><a href="{% url image_edit_acquisition image.id %}">{% trans "Edit acquisition details" %}</a></span>
                                    </li>
                                    <li class="bg-icon icon-upload">
                                        <span class="text"><a class="upload-revision" href="#">{% trans "Upload new revision" %}</a></span>
                                    </li>
                                    <li class="bg-icon icon-delete">
                                        <span class="text"><a class="delete danger" href="{% url image_delete image.id %}">{% trans "Delete" %}</a></span>
                                    </li>
                                    <li class="separator"></li>
                                {% endif %}
                                    <li class="bg-icon icon-quote">
                                        <span class="text"><a class="bring-to-attention" href="#">{% trans "Bring to a user's attention" %}</a></span>
                                    </li>
                                {% if request.user != image.user %}
                                    <li class="bg-icon icon-info">
                                        <span class="text"><a class="image-request-additional-information" href="#">{% trans "Request additional information" %}</a></span>
                                    </li>
                                    <li class="last bg-icon icon-file">
                                        <span class="text"><a class="image-request-fits" href="#">{% trans "Request TIFF/FITS" %}</a></span>
                                    </li>
                                {% endif %}
                                </ul>
                            </div>
                        </li>
                        <li id="view">
                            <span class="text"><a href="#">{% trans "View" %}</a></span>
                            <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                            <div class="sub">
                                <ul class="subnav">
                                    <li class="first {% if inverted or solved %}bg-icon icon-normal{% else %}bg-icon icon-inverted{% endif %}">
                                        {% if inverted or solved %}
                                        <span class="text"><a href="{{image.get_absolute_url}}/">{% trans "Normal" %}</a></span>
                                        {% else %}
                                        <span class="text"><a href="{{image.get_absolute_url}}/?mod=inverted">{% trans "Inverted monochrome" %}</a></span>
                                        {% endif %}
                                    </li>
                                    {% if image.is_solved %}
                                    <li class="last bg-icon icon-solved">
                                        <span class="text"><a href="{{image.get_absolute_url}}/?mod=solved">{% trans "Annotated" %}</a></span>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </li>
                        {% if request.user != image.user %}
                        <li id="user">
                            <span class="text"><a href="#">{% trans "User" %}</a></span>
                            <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                            <div class="sub">
                                <ul class="subnav">
                                    <li class="first {% if not request.user.is_authenticated %}last{% endif %} bg-icon icon-profile">
                                        <span class="text"><a href="{{image.user.get_absolute_url}}">{% trans "View profile" %}</a></span>
                                    </li>
                                    {% if request.user.is_authenticated %}
                                    <li class="bg-icon {% if follows %}icon-unfollow{% else %}icon-follow{% endif %}">
                                        <span class="text">
                                            <a class="{% if follows %}unfollow{% else %}follow{% endif %}"
                                               href="{% if follows %}{% url unfollow image.user %}{% else %}{% url follow image.user %}{% endif %}?next={{request.path}}">
                                                {% if follows %}
                                                    {% trans "Stop following" %}
                                                {% else %}
                                                    {% trans "Follow" %}
                                                {% endif %}
                                            </a>
                                        </span>
                                    </li>
                                    <li class="last bg-icon icon-message">
                                        <span class="text"><a class="send-private-message" href="{% url messages_new image.user %}">{% trans "Send private message" %}</a></span>
                                    </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </li>
                        {% endif %}
                        <li id="share" class="last">
                            <span class="text"><a href="#">{% trans "Share" %}</a></span>
                            <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                            <div class="sub">
                                <ul class="subnav">
                                    <li class="first copy-box">
                                        <span class="text">{% trans "Direct link:" %}</span>
                                        <span class="copy-box">http://astrob.in/{{image.id}}/</span>
                                    </li>
                                    <li class="last copy-box">
                                        <span class="text">{% trans "Forms link:" %}</span>
                                        <span class="copy-box">[URL=http://astrob.in/{{image.id}}/]{{image.title|escape}}[/URL]</span>
                                    </li>
                                </ul>
                            </div>
                        </li>
                    </ul>
                </li>
                {% if not full %}
                <li class="rating"><div id="rating"></div></li>
                {% endif %}
            </ul>
            <div id="main-image">
            {% if is_ready %}
                {% if is_revision %}
                    {% with revision_image as image %}
                        {% if inverted %}
                        <a class="zoomable" href="{% url image_detail image.image.id %}?r={{image.id}}&mod=inverted{% if not full %}&full{% endif %}">
                            <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}{% if not full %}_resized{% endif %}_inverted{{image.original_ext}}" alt="{{image.title|escape}}"/>
                        </a>
                        {% endif %}
                        {% if solved %}
                        <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_solved.png" alt="{{image.title|escape}}"/>
                        {% endif %}
                        {% if not inverted and not solved %}
                        <a class="zoomable" href="{% url image_detail image.image.id %}{% if not full %}?r={{image.id}}&full{% endif %}">
                            <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}{% if not full %}_resized{% endif %}{{image.original_ext}}" alt="{{image.title|escape}}"/>
                        </a>
                        {% endif %}
                    {% endwith %}
                {% else %}
                    {% if inverted %}
                    <a class="zoomable" href="{% url image_detail image.id %}?mod=inverted{% if not full %}&full{% endif %}">
                        <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}{% if not full %}_resized{% endif %}_inverted{{image.original_ext}}" alt="{{image.title|escape}}"/>
                    </a>
                    {% endif %}
                    {% if solved %}
                    <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_solved.png" alt="{{image.title|escape}}"/>
                    {% endif %}
                    {% if not inverted and not solved %}
                    <a class="zoomable" href="{% url image_detail image.id %}{% if not full %}?full{% endif %}">
                        <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}{% if not full %}_resized{% endif %}{{image.original_ext}}" alt="{{image.title|escape}}"/>
                    </a>
                    {% endif %}
                {% endif %}
            {% else %} <!-- not ready -->
            <p class="info">
                {% blocktrans %}This image was just uploaded and is still processing. Please try again in a few seconds.{% endblocktrans %}
            </p>
            {% endif %}
            </div>

            {% if not full %}
            <div class="main-image-data">
                <ul>
                    <li class="title">{{image.title|escape|default:_("(no title)")}}</li>
                    <li class="uploaded">({% trans "uploaded on" %} {{image.uploaded}}</li>
                    <li class="author">{% trans "by" %} <a href="{% url user_page image.user.username %}">{{image.user.username}}</a>)</li>
                    {% if image.subjects %}
                    {% endif %}
                </ul>
                <div class="hline"></div>
                <p>
                    {% trans "Contains" %}:
                    {% for s in image.subjects.all %}
                        <a href="/search/?q={{s.mainId|escape}}">{{s.mainId|escape}}</a>
                        {% if not forloop.last %},&nbsp;{% endif %}
                    {% empty %}
                        {% trans "(no subjects)" %}
                    {% endfor %}
                </p>
            </div>
            {% if revisions or is_revision %}
            <div id="revisions">
                <h3>
                    {% if is_revision %}
                        {% trans "This image is a revision. Here are its older versions" %}:
                    {% else %}
                        {% trans "This image has some later revisions" %}:
                    {% endif %}
                </h3>
                <div class="image-strip clear">
                    {% if is_revision %}
                    <div style="float:left; width:{{small_thumbnail_size}}; height:{{small_thumbnail_size}}; padding: 2px">
                        <a href="{{image.get_absolute_url}}">
                            <img src="{% if image.is_stored %}http://astrobin_images.{{s3_url}}/{{image.filename}}_small_thumb{{image.original_ext}}{% else %}/static/icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="" width="{{small_thumbnail_size}}" height="{{small_thumbanail_size}}"/>
                        </a>
                    </div>
                    {% endif %}
                    {% for i in revisions %}
                    <div style="float:left; width:{{small_thumbnail_size}}; height:{{small_thumbnail_size}}; padding: 2px">
                        <a href="{{i.get_absolute_url}}">
                            <img src="{% if image.is_stored %}http://astrobin_images.{{s3_url}}/{{i.filename}}_small_thumb{{i.original_ext}}{% else %}/static/icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="" width="{{small_thumbnail_size}}" height="{{small_thumbanail_size}}"/>
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            <h3>{% trans "Technical card" %}</h3>
            <div id="technical-card">
                <div class="gear">
                    {% for i in gear_list %}
                        <p>
                            <strong>{% trans i.0 %}:&nbsp;</strong>
                            {% for g in i.1 %}
                                <a href="/search/?q={{g.name|escape}}">{{g.name|escape}}</a>
                                {% if not forloop.last %},&nbsp;{% endif %}
                            {% endfor %}
                        </p>
                    {% endfor %}
                </div>
                <div class="acquisition">
                    {% if image_type == 'deep_sky' %}
                        {% for d in deep_sky_data %}
                            {% if d.1 %}
                                <p>
                                <strong>{% trans d.0 %}:&nbsp;</strong>
                                {% for i in d.1 %}
                                    {{i}}
                                    {% if not forloop.last %},&nbsp;{% endif %}
                                {% endfor %}
                                </p>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    {% if is_ready %}
                    <hr/>
                    <h4>{% trans "Histogram" %}</h4>
                    <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_hist.png" alt="{% trans "Histogram" %}"/>
                    {% endif %}
                </div>
            </div>

            <h3>{% trans "Description" %}</h3>
            <p id="description">{{image.description|escape}}</p>
        </div>
        <div id="side-pane">
            {% if related_images.count > 1 %} 
            <ul class="topnav">
                <li>
                    <span class="text"><a href="#">{% trans "More..." %}</a></span>
                    <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                    <div class="sub">
                        <ul class="subnav">
                            <li><a href="{{image.get_absolute_url}}/?related=user">{% trans "Same user" %} ({{image.user.username}})</a></li>
                            <li><a href="{{image.get_absolute_url}}/?related=subject">{% trans "Same subject" %}</a></li>
                            <li><a href="{{image.get_absolute_url}}/?related=imaging_telescope">{% trans "Same imaging telescope" %}</a></li>
                            <li><a href="{{image.get_absolute_url}}/?related=imaging_camera">{% trans "Same imaging camera" %}</a></li>
                        </ul>
                    </div>
                </ul>
            </ul>

            <div class="image-strip clear">
            {% for i in related_images %}
                <div style="float:left; width:{{small_thumbnail_size}}; height:{{small_thumbnail_size}}; padding: 2px">
                    <a href="{{i.object.get_absolute_url}}/">
                        <img src="{% if i.object.is_stored %}http://astrobin_images.{{s3_url}}/{{i.object.filename}}_small_thumb{{i.object.original_ext}}{% else %}/static/icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="{{i.object.title|escape}}" width="{{small_thumbnail_size}}" height="{{small_thumbanail_size}}"/>
                    </a>
                </div>
            {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %} <!-- full -->
    </div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="/static/js/jquery.raty.min.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    image_detail.init(
        {{image.id}},
        "{{image.user.username}}",
        {{current_rating}},
        {
            rating: {
                hint_list: [
                    "{% trans "Bad" %}",
                    "{% trans "Poor" %}",
                    "{% trans "Regular" %}",
                    "{% trans "Good" %}",
                    "{% trans "Gorgeous" %}"],
                read_only: {% if request.user.is_authenticated %} false {% else %} true {% endif %}
            },
            upload_revision_action: {
                dialog: {
                    title: "{% trans "Upload new revision" %}",
                    body : "{% blocktrans %}Did you improve the post-processing of your image? Upload the new revision!{% endblocktrans %}"
                },
                form_html: '{% autoescape off %}{{upload_revision_form.as_p|append_slash}}{% endautoescape %}'
            },
            delete_action: {
                dialog: {
                    title : "{% trans "Delete image?" %}",
                    body  : "{% trans "The image will be permanently deleted and cannot be recovered. All its revisions will be deleted too. Are you sure?"%}",
                    button: "{% trans "Yes, delete image" %}"
                }
            },
            follow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Follow {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will receive a notification every time {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, follow!" %}"
                },
                stop_following: "{% trans "Stop following" %}"
            },
            unfollow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Stop following {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will stop receiving notifications when {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, stop following!" %}"
                },
                follow: "{% trans "Follow" %}"
            },
            message_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Send {{username}} a message{% endblocktrans %}",
                    body  : "",
                    button: "{% trans "Send" %} &rarr;"
                },
                form_html: '{% autoescape off %}{{private_message_form.as_p|append_slash}}{% endautoescape %}',
                url      : "{% url send_private_message %}"
            },
            bring_to_attention_action: {
                dialog: {
                    title : "{% trans "Bring image to attention" %}",
                    body  : "{% blocktrans %}By choosing some users and clicking the button below, you will send them a notification prompting them to checkout this image.{% endblocktrans %}",
                    button: "{% trans "Continue" %} &rarr;"
                },
                form_html: '{% autoescape off %}{{bring_to_attention_form.as_p|append_slash}}{% endautoescape %}',
                autocomplete: {
                    startText: "{% trans "Enter partial name" %}",
                    emptyText: "{% trans "User not found. Cannot notify them." %}"
                },
                url: "{% url bring_to_attention %}"
            },
            image_request_additional_information_action: {
                dialog: {
                    title : "{% trans "Request additional information" %}",
                    body  : "{% blocktrans with image.user.username as username %}You will notify {{username}} that you would like them to feed more information in the technical card for this photograph. Continue?{% endblocktrans %}",
                }
            },
            image_request_fits_action: {
                dialog: {
                    title : "{% trans "Request TIFF/FITS" %}",
                    body  : "{% blocktrans with image.user.username as username %}You will notify {{username}} that you would like see the TIFF or FITS file. AstroBin doesn\'t currently offer to host such large files, so hopefully {{username}} will contact you about how to handle the transaction. Continue?{% endblocktrans %}",
                }
            }
        });

    });
</script>
{% endblock %}


{% extends 'base.html' %}
{% load i18n %}
{% load tags %}
{% load pagination_tags %}
{% load bootstrap_toolkit %}

{% block title %}AstroBin - {% blocktrans with user=user %}{{user}}'s commercial products{% endblocktrans %}{% endblock %}

{% block content %}
    {% include 'user/profile-subnav.html' %}
    <h1>
        {% ifequal user request.user %}
            {% blocktrans %}Your commercial products{% endblocktrans %}
        {% else %}
            {% blocktrans with user as user %}{{user}}'s commercial products{% endblocktrans %}
        {% endifequal %}
    </h1>

    <div class="row section">
        <div class="span12">
            <table class="table commercial-gear-items">
                <tr>
                    <th>{% trans "Gear IDs" %}</th>
                    <th>{% trans "Make" %}</th>
                    <th>{% trans "Name" %}</th>
                    <th>{% trans "Owners" %}</th>
                    <th>{% trans "Images" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
                {% for item in commercial_gear_list %}
                    <tr data-id="{{item.id}}">
                        <td class="gear-ids" data-gear-ids="{% for g in item.gear_set.all %}{{g.id}}{% if not forloop.last %},{% endif %}{% endfor %}">
                            {% for g in item.gear_set.all %}
                                <a href="/gear/{{g.id}}/">{{g.id}}</a>{% if not forloop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% if item.proper_make %}
                                {{item.proper_make}}
                            {% else %}
                                {{item.gear_set.all.0.make}}
                            {% endif %}
                        </td>
                        <td>
                            {% if item.proper_name %}
                                {{item.proper_name}}
                            {% else %}
                                {{item.gear_set.all.0.name}}
                            {% endif %}
                        </td>
                        <td>{% gear_set_owners item.gear_set %}</td>
                        <td>{% gear_set_images item.gear_set %}</td>
                        <td>
                            <a rel="tooltip" title="{% trans "View" %}" href="{% url gear_page item.gear_set.all.0.id %}">
                                <i class="icon-eye-open icon-white"></i>
                            </a>
                            <a rel="tooltip" title="{% trans "Edit" %}" href="{% url commercial_products_edit item.id %}">
                                <i class="icon-edit icon-white"></i>
                            </a>
                            <a class="item-merge" rel="tooltip" title="{% trans "Merge" %}" href="#">
                                <i class="icon-plus-sign icon-white"></i>
                            </a>
                            <a class="item-remove" rel="tooltip" title="{% trans "Remove" %}" href="#">
                                <i class="icon-remove icon-white"></i>
                            </a>
                        </td>
                    </tr>
                {% empty %}
                    <tr class="empty">
                        <td colspan="6">
                            {% ifequal user request.user %}
                                {% trans "You haven't claimed any commercial products yet." %}
                            {% else %}
                                {% blocktrans with user as user %}{{user}} hasn't claimed any commercial products yet.{% endblocktrans %}
                            {% endifequal %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>

    {% if is_producer or is_retailer %}
        <a href="#claim-commercial-product-modal"
           class="btn btn-primary claim-commercial-product"
           data-toggle="modal">{% trans "Claim commercial product" %}</a>
    {% endif %}
{% endblock %}

{% block modals %}
    <div class="modal hide fade" id="claim-commercial-product-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Claim commercial product" %}</h3>
        </div>
        <div class="modal-body">
            <form id="claim-commercial-product" class="form-horizontal" action="{% url commercial_products_claim 0 %}" method="post">
                <div class="form-content">
                    {{claim_commercial_gear_form|as_bootstrap}}
                </div>
                <div class="form-actions">
                    <input type="submit" class="btn btn-primary" value="{% trans "Claim" %}"/>
                </div>
            </form>
        </div>
    </div>

    <div class="modal hide fade" id="remove-commercial-products-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Select items to remove" %}</h3>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                {% blocktrans %}Be careful if you try to remove all of these!{% endblocktrans %}
                {% blocktrans %}All the properties, including the commercial description, of this claim will be deleted and cannot be recovered!{% endblocktrans %}
            </div>
            <form id="remove-commercial-product" class="form-inline">
                <div class="form-content">
                    <div class="loading"><img src="{{STATIC_URL}}images/loading-bar.gif" alt=""/></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Cancel</a>
            <a href="#" class="remove btn btn-primary">{% trans "Remove" %}</a>
        </div>
    </div>

    <div class="modal hide fade" id="merge-commercial-products-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Select the product you want to merge to" %}</h3>
        </div>
        <div class="modal-body">
            <form id="merge-commercial-product" class="form-horizontal">
                <div class="form-content">
                    {{merge_commercial_gear_form|as_bootstrap}}
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Cancel</a>
            <a href="#" class="merge btn btn-primary">{% trans "Merge" %}</a>
        </div>
    </div>

    <div class="modal hide fade" id="remove-commercial-products-confirmation-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Are you sure?" %}</h3>
        </div>
        <div class="modal-body">
            {% blocktrans %}All the properties, including the commercial description, of this claim will be deleted and cannot be recovered!{% endblocktrans %}
            <strong>{% blocktrans %}Are you sure?{% endblocktrans %}</strong>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn" data-dismiss="modal">Cancel</a>
            <a href="#" class="btn btn-primary">Continue</a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    {% include 'user/profile-js.html' %}

    <script type="text/javascript">
        $(document).ready(function() {
            var $form = $('form#claim-commercial-product'),
                $makes = undefined,
                $names = undefined,
                $merge_with = undefined,
                $merge_with_later = undefined,
                $btn = undefined;

            $merge_with_later = $('form#merge-commercial-product select[name=merge_with]');

            var reset_form_vars = function() {
                $makes = $form.find('select[name=make]');
                $names = $form.find('select[name=name]');
                $merge_with = $form.find('select[name=merge_with]');
                $btn = $form.find('input[type=submit]');
            }

            var reset_form_btn = function() {
                $btn.removeClass('disabled');
                $btn.val("{% trans "Claim" %}");
            }

            var disable_form_btn = function() {
                $btn.addClass('disabled');
                $btn.val("{% trans "Please wait..." %}");
            }

            var on_makes_changed = function() {
                var make = $.trim($(this).val());
                if (make != '') {
                    $.ajax({
                        url: '/gear/by-make/' + make + '/?unclaimed=true',
                        dataType: 'json',
                        timeout: 10000,
                        cache: false,
                        success: function(data, status, request) {
                            $names.find('option').remove();

                            $.each(data.gear, function(index, value) {
                                var $opt = $('<option/>');
                                $opt.attr('value', value.id);
                                $opt.text(value.name);
                                $names.append($opt);
                            });

                            var id = $names.find('option:first').val();
                            $form.attr('action', '/commercial/products/claim/' + id  + '/');
                        }
                    });
                }
            }

            var on_names_changed = function() {
                var id = $(this).val();
                $form.attr('action', '/commercial/products/claim/' + id + '/');
            }

            var ajaxFormOptions = {
                dataType: 'json',
                timeout: 10000,
                beforeSubmit: function(formData, $form, options) {
                    disable_form_btn();
                },
                success: function(response) {
                    reset_form_vars();
                    if (response.success) {
                        $('#claim-commercial-product-modal').modal('hide');

                        if (response.is_merge) {
                            $('tr[data-id=' + response.id + '] td.gear-ids').html(response.gear_ids_links);
                            $('tr[data-id=' + response.id + '] td.gear-ids').attr('data-gear-ids', response.gear_ids);
                        } else {
                            var $table = $('table.commercial-gear-items');
                            var $row = $('<tr/>');

                            $table.find('tr.empty').remove();
                            
                            $row.attr('data-id', response.id);
                            $row.append('<td class="gear-ids" data-gear-ids="' + response.gear_ids + '">' + response.gear_ids_links + '</td>');
                            $row.append('<td>' + response.make + '</td>');
                            $row.append('<td>' + response.name + '</td>');
                            $row.append('<td>' + response.owners + '</td>');
                            $row.append('<td>' + response.images + '</td>');

                            $row.append('\
                            <td>\
                                <a rel="tooltip" title="{% trans "View" %}" href="/gear/' + response.gear_ids + '">\
                                    <i class="icon-eye-open icon-white"></i>\
                                </a>\
                                <a rel="tooltip" title="{% trans "Edit" %}" href="/commercial/products/edit/' + response.id + '">\
                                    <i class="icon-edit icon-white"></i>\
                                </a>\
                                <a class="item-merge" rel="tooltip" title="{% trans "Merge" %}" href="#">\
                                    <i class="icon-plus-sign icon-white"></i>\
                                </a>\
                                <a class="item-remove" rel="tooltip" title="{% trans "Remove" %}" href="#">\
                                    <i class="icon-remove icon-white"></i>\
                                </a>\
                            </td>');

                            $table.append($row);

                            // Add this to the merge_with fields.
                            $merge_with.append($('<option/>')
                                .val(response.id)
                                .text(response.name)
                            );

                            $merge_with_later.append($('<option/>')
                                .val(response.id)
                                .text(response.name)
                            );
                        }
                    } else {
                        $form.find('.form-content').html(response.form);
                        reset_form_vars();
                        on_makes_changed.apply($makes);
                        $makes.change(on_makes_changed);
                        $names.change(on_names_changed);
                    }

                    reset_form_btn();
                },
                error: function(response, statusText, xhr) {
                    reset_form_vars();
                    $makes.change(on_makes_changed);
                    $names.change(on_names_changed);
                    $form.find('.form-content').html(response.form);
                    reset_form_btn();
                }
            };

            reset_form_vars();
            $form.ajaxForm(ajaxFormOptions);
            $makes.change(on_makes_changed);
            $names.change(on_names_changed);

            $('#claim-commercial-product-modal').on('show', function() {
                $makes.val($makes.find('option:first').val()); 
                $names.find('option').remove();

                var $opt = $('<option/>');
                $opt.attr('value', '');
                $opt.text('---------');
                $names.append($opt);

                $merge_with.val(0);

                $form.attr('action', '{% url commercial_products_claim 0 %}');

                $form.find('.control-group.error').removeClass('error');
                $form.find('.help-block.error').remove();
                $form.find('.alert-error').remove();
                reset_form_btn();
            });

            $('#merge-commercial-products-modal').on('show', function() {
                $merge_with_later.val(0);
            });

            $('#remove-commercial-products-modal').find('a.remove').click(function() {
                $('#remove-commercial-products-modal').find('form').submit();
            });

            $('#remove-commercial-products-modal').find('form').submit(function() {
                var promises = [];
                var $modal = $(this).closest('.modal');

                $(this).find('input:checkbox:checked').each(function() {
                    promises.push(
                        $.ajax({
                            url: '/commercial/products/unclaim/' + $(this).val() + '/',
                            dataType: 'json',
                            timeout: 10000,
                            cache: false
                        }));
                });

                $.when.apply($, promises).done(function(result) {
                    var l = arguments.length,
                        response;

                    if (promises.length === 1) {
                        response = $.parseJSON(arguments[2].responseText);
                    } else {
                        // We only care about the last one.
                        response = $.parseJSON(arguments[l - 1][2].responseText);
                    }

                    $table_row = $('tr[data-id=' + response.commercial_id + ']');
                    if (response.commercial_was_removed) {
                        $table_row.remove();
                        $merge_with.find('option[value=' + response.commercial_id + ']').remove();
                        $merge_with_later.find('option[value=' + response.commercial_id + ']').remove();
                    } else {
                        $table_row.find('td.gear-ids').html(response.claimed_gear_ids_links);
                        $table_row.find('td.gear-ids').attr('data-gear-ids', response.claimed_gear_ids);
                    }
                    
                    $modal.modal('hide');
                });

                return false;
            });

            $('.item-remove').live('click', function() {
                var $link = $(this);
                var $table_row = $(this).closest('tr');
                var ids = $table_row.find('td.gear-ids').attr('data-gear-ids');
                var id_list = ids.split(',');

                if (id_list.length == 1) {
                    var $modal = $('#remove-commercial-products-confirmation-modal');
                    $modal.find('a.btn-primary').click(function() {
                        $.ajax({
                            url: '/commercial/products/unclaim/' + id_list[0] + '/',
                            dataType: 'json',
                            timeout: 10000,
                            cache: false,
                            success: function(data, status, request) {
                                $table_row.find('a[rel=tooltip]').tooltip('hide');
                                $table_row.remove();
                                $merge_with.find('option[value=' + data.commercial_id + ']').remove();
                                $merge_with_later.find('option[value=' + data.commercial_id + ']').remove();
                                $modal.modal('hide');
                            }
                        });
                    });
                    $modal.modal('show');
                 } else {
                    var $modal = $('#remove-commercial-products-modal');
                    var $form_content = $modal.find('.form-content');
                    $modal.modal('show');

                    $.ajax({
                        url: '/gear/by-ids/' + ids + '/',
                        dataType: 'json',
                        timeout: 10000,
                        cache: false,
                        success: function(data, status, request) {
                            $form_content.html('');
                            for (var i = 0; i < data.length; i++) {
                                var $template = $('\
                                    <div class="control-group">\
                                        <div class="controls">\
                                            <label class="checkbox">\
                                                <input type="checkbox" />' + '(' + data[i][0] + ') ' + data[i][1] + ' ' + data[i][2] + '\
                                            </label>\
                                        </div>\
                                    </div>');

                                var $input = $template.find('input');
                                $input
                                    .attr('id', 'id_remove_' + data[i][0])
                                    .attr('name', 'remove_' + data[i][0])
                                    .val(data[i][0]);

                                $form_content.append($template);
                                $input.uniform();
                            }
                        }
                    });
                 }

                 return false;
            });

            $('.item-merge').live('click', function() {
                var $modal = $('#merge-commercial-products-modal');
                $modal.data('from_id', $(this).closest('tr').attr('data-id'));

                $modal.modal('show');
                return false;
            });


            $('#merge-commercial-products-modal').find('a.merge').click(function() {
                $('#merge-commercial-products-modal').find('form').submit();
            });

            $('#merge-commercial-products-modal').find('form').submit(function() {
                var from_id = $(this).closest('.modal').data('from_id'),
                    to_id = $(this).find('select option:selected').val(),
                    $modal = $('#merge-commercial-products-modal');

                $.ajax({
                    url: '/commercial/products/merge/' + from_id + '/' + to_id + '/',
                    dataType: 'json',
                    timeout: 10000,
                    cache: false,
                    success: function(response, status, request) {
                        $('tr[data-id=' + from_id + ']').remove();
                        $merge_with.find('option[value=' + from_id + ']').remove();
                        $merge_with_later.find('option[value=' + from_id + ']').remove();

                        var $gear_ids_td = $('tr[data-id=' + to_id + '] td.gear-ids');
                        $gear_ids_td.html(response.claimed_gear_ids_links);
                        $gear_ids_td.attr('data-gear-ids', response.claimed_gear_ids);

                        $modal.modal('hide');
                    }
                });

                return false;
            });
        });
    </script>
{% endblock %}

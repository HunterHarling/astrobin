{% extends 'base.html' %}
{% load i18n %}
{% load tags %}

{% block content %}
    {% include 'profile-edit-menu.html' %}
    <div class="sided-main-content">
        <h1>{% trans "Edit your astrophotography gear" %}</h1>
        <table class="form_saved_container">
            <tr>
                <td>{% form_saved request %}</td>
                {% if request.GET.initial == 'true' %}
                <td><a href="/">{% trans "Go back to the home page." %}</a></td>
                {% endif %}
            </tr>
        </table>
        <p><strong>{% blocktrans %}Please use full names (make and model) for all your gear items!{% endblocktrans %}</strong></p>
        <p>{% blocktrans %}<span class="button">Orange</span> bubbles mean that you need to edit the properties of that gear item!{% endblocktrans %}</p>
        <form method="post" action="{% url profile_save_gear %}">{% csrf_token %}
            {{form.as_p}}
            {% if initial %}
            <input type="hidden" name="initial"/>
            {% endif %}
            <noscript>
                <p class="hint">
                {% blocktrans %}* use a comma to separate the values.{% endblocktrans %}
                </p>
            </noscript>
            <p><input class="button submit-button" type="submit" value="{% trans "Save" %}" /></p>
        </form>
    </div>  
{% endblock %}

{% block extra_js %}
    <script language="javascript">
    $(document).ready(function() {
        var startText = "";
        var emptyText = "{% trans "No results. Press TAB to add it!" %}";
        var resultsTitleText = "{% trans "Click on a suggestion or press TAB to add what you typed" %}";
        {% autoescape off %}
        {% for key, value in prefill_dict.items %}
        $('#id_{{key}}').autoSuggest('/autocomplete/{{key}}/',
            {asHtmlID: '{{key}}',
            searchObjProps: 'name',
            preFill: {{value}},
            selectedItemProp: 'id',
            selectedValuesProp: 'name',
            startText: startText,
            emptyText: emptyText,
            resultsTitleText: resultsTitleText,
            allowEdit: true});
        {% endfor %}
        {% endautoescape %}

        $('.as-edit').live('click', function(event) {
            event.preventDefault();

            var id = $(this).data('id');
            var name = $(this).siblings('.data').text();
            var $dlg = $('<div/>').attr('title', name);
            var type = $(this).closest('ul.as-selections').attr('id').replace('as-selections-', '');
            var $item_li = $(this).closest('li.as-selection-item');

            $.ajax({
                url: '/get_edit_gear_form/' + id + '/',
                dataType: 'json',
                timeout: 5000,
                success: function(data, textStatus, XMLHttpRequest) {
                    var $form;

                    var ajaxFormOptions = {
                        dataType: 'json',
                        beforeSubmit: function(formData, $form, options) {
                            $dlg.find('button').addClass('ui-state-disabled');
                        },
                        success: function(responseJson, statusText, xhr, $form) {
                            if (responseJson['success']) {
                                $dlg.dialog('close');
                                $.ajax({
                                    url: '/get_is_gear_complete/' + id + '/',
                                    dataType: 'json',
                                    timeout: 5000,
                                    success: function(data, textStatus, XMLHttpRequest) {
                                        if (data['complete'])
                                            $item_li.removeClass('need-data');
                                        else
                                            $item_li.addClass('need-data');
                                    }
                                });
                            } else {
                                $form = createForm(responseJson, id); 
                            }
                        },
                        error: function(responseText, statusText, xhr, $form) {
                            $dlg.find('button').removeClass('ui-state-disabled');
                        }
                    };

                    var createForm = function(data, id) {
                        var $form = $dlg.find('form').remove();
                        $dlg.append("\
                            <form action=\"{% url save_gear_details %}\" method=\"post\">" +
                                data['form'] + "\
                                <input type=\"hidden\" name=\"gear_id\" value=\"" + id + "\"/>\
                                <input type=\"submit\" class=\"button\" value=\"{% trans "Save" %}\"/>\
                            </form>\
                        ");
                        $form = $dlg.find('form');
                        $form.ajaxForm(ajaxFormOptions);
                        return $form;
                    };

                    $form = createForm(data, id);

                    $dlg.dialog({
                        resizable: true,
                        modal: true
                    });
                },
                error: function(XmlHttpRequest, textStatus, errorThrown) {
                    alert("Error: " + textStatus);
                }
            });
        });
    });
    </script>
{% endblock %}


# Distribution packages:
# ======================

# We need Mercurial 1.8+ for git submodule support
sudo add-apt-repository ppa:mercurial-ppa/releases

sudo apt-get update
sudo apt-get install \
	apt-file \
	vim \
	git \
	mercurial \
	python2.7-dev \
	mysql-server \
	libmysqlclient-dev \
	memcached \
	rabbitmq-server \
	python-pip \
	build-essential \
	uuid-dev \
	libpcre3-dev \
	libcairo2-dev \
	libjpeg8-dev \
	netpbm \
	netpbm10-dev \
	python-numpy
sudo apt-file update
sudo pip install virtualenv

# Install things needed by the CSS compiler
cd /tmp
sudo apt-get install git-core curl build-essential openssl libssl-dev
git clone https://github.com/joyent/node.git && cd node
git checkout v0.4.9 # or whatever the latest stable is
./configure && make
sudo make install
curl http://npmjs.org/install.sh | sudo sh
npm install less
echo "alias lessc=/home/astrobin/.npm/less/1.1.2/package/bin/lessc" >> ~/.bashrc

# Obtain the code:
# ================

hg clone https://bitbucket.org/siovene/astrobin astrobin


# Python packages:
# ================

cd astrobin
virtualenv --no-site-packages venv
ln -s ./venv/bin/pip vpip

# setproctitle must be installed first
./vpip install setproctitle
./vpip install \
    yolk \
    django \
    django-haystack xapian-haystack \
    django-celery celerymon \
    gunicorn gunicorn-console \
    django-debug-toolbar \
    MySQL-python \
    django-ratings \
    django-memcached \
    django-storages boto \
    simplejson \
    django-compressor \
    django-registration \
    django-notification \
    flickrapi \
    Pillow \
    python-memcached \
    django-model-utils

# NOTE: if you run into this: https://github.com/ask/celery/commit/edf3b3f33acdada9264754068d9c74ee76692cd9
# then install kombu, celery and django-celery from git master:
#
# git clone https://github.com/ask/kombu.git
# git clone https://github.com/ask/celery.git
# git clone https://github.com/ask/django-celery.git
# cd kombu; ../astrobin/venv/bin/python setup.py install; cd ..
# cd celery; ../astrobin/venv/bin/python setup.py install; cd ..
# cd django-celery; ../astrobin/venv/bin/python setup.py install; cd ..

# for the notifications system
cd django-persistent-messages
../venv/bin/python setup.py install

# for the private beta
cd django-privatebeta
../venv/bin/python setup.py install

# for the moon phase module
easy_install -i http://downloads.egenix.com/python/index/ucs4/ egenix-mx-base


# Set up Xapian:
# ==============

. ./venv/bin/activate
cd xapian-core-1.2.6
./configure --prefix=/opt && make && sudo make install
cd ../xapian-bindings-1.2.6
XAPIAN_CONFIG=/opt/bin/xapian-config ./configure --prefix=/opt && make && sudo make install
deactivate


# Set up MySQL:
# =============

mysql -u user -p (password is astrobin)
> create user 'astrobin'@'localhost' identified by 'astrobin';
> create database astrobin character set utf8;

# Initialize db
./scripts/syncdb.sh
(When asked, do create super user astrobin:astrobin <astrobin@astrobin.com>)


# Build nginx:
# ============

cd nginx-1.0.4
./configure --add-module=../nginx_http_push_module
make
sudo make install

# Use nginx config
Add 'include /home/astrobin/Code/astrobin/astrobin.com.nginx;' to the http{} section of /usr/local/nginx/conf/nginx.conf.


# Configure rabbitmq:
# ===================

sudo rabbitmqctl add_user astrobin astrobin
sudo rabbitmqctl add_vhost astrobin
sudo rabbitmqctl set_permissions -p astrobin astrobin ".*" ".*" ".*"


# Build astrometry.net:
# =====================

cd astrometry.net-0.38
./configure
make
make extra
sudo make install


# Build index:
# ============

./scripts/rebuild_index.sh

# Add new language:
# =================
cd astrobin;
../venv/bin/django-admin.py makemessages -l se # Example for swedish


# Compile languages:
cd astrobin;
../venv/bin/django-admin.py compilemessages


# Set site name:
# ==============

Go to: http://localhost/admin/sites/site/1/

and set site's properties.


# Run it!
# =======
./scripts/nginx.sh
./scripts/celeryd_default.sh &
./scripts/celeryd_plate_solve.sh &
./scripts/gunicorn.sh &

or use ./start.sh

# (replace gunicorn.sh with run.sh if you want to debug)

Go to http://localhost/


# Restart gunicorn
# ================
kill -HUP `cat astrobin.pid`


# Run tasks regularly:
# ====================

# Update images index
*/1 * * * * (cd ~/Code/astrobin; ./scripts/update_index.sh) 2>&1 >/dev/null


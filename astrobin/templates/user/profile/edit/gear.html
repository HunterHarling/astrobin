{% extends 'base.html' %}
{% load i18n %}
{% load tags %}
{% load bootstrap_toolkit %}

{% block content %}
    {% include 'profile-edit-menu.html' %}
    <div class="row">
        <div class="span12">
            <h1>{% trans "Edit your astrophotography gear" %}</h1>
            <table class="form_saved_container">
                <tr>
                    <td>{% form_saved request %}</td>
                    {% if request.GET.initial == 'true' %}
                    <td><a href="/">{% trans "Go back to the home page." %}</a></td>
                    {% endif %}
                </tr>
            </table>

            {% for label, gear_items in prefill.items %}
                {% list_gear label gear_items.0 gear_items.1 request.user %}
            {% endfor %}
        </div> <!-- span12 -->
    </div> <!-- row -->
{% endblock %}

{% block modals %}
    <div class="modal hide fade" id="edit-gear-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Edit gear item" %}</h3>
        </div>
        <div class="modal-body">
            <div class="well">
                <strong>{% trans "Please note!" %}</strong>
                {% blocktrans %}When you add or edit the make, the name, and the properties of this product, the data is global and shared between all AstroBin users. Do not write any information in there that refers to your personal copy of this product, like "modded", "sold", "broken", "a present from my aunt" and so on. {% endblocktrans %}
            </div>

            <form class="form-horizontal global" action="{% url save_gear_details %}" method="post">
                <div class="form-content"></div>
                <input type="hidden" name="gear_id" value="" />
                <div class="form-actions">
                    <input type="submit" class="btn btn-primary" value="{% trans "Save" %}"/>
                    <input type="button" class="btn close-modal" value="{% trans "Close" %}"/>
                </div>
            </form>

            <div class="well">
                {% blocktrans %}The following information, instead, is personal, and may refer to your copy of this product.{% endblocktrans %}
            </div>

            <form class="form-horizontal custom" action="{% url save_gear_user_info %}" method="post">
                <div class="form-content"></div>
                <input type="hidden" name="gear_id" value="" />
                <div class="form-actions">
                    <input type="submit" class="btn btn-primary" value="{% trans "Save" %}"/>
                    <input type="button" class="btn close-modal" value="{% trans "Close" %}"/>
                </div>
            </form>

        </div>
    </div>

    <div class="modal hide fade" id="add-gear-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Add gear item" %}</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal" action="{% url save_gear_details %}" method="post">
                <div class="form-content"></div>
                <div class="form-actions">
                    <input type="submit" name="save" class="btn btn-primary" value="{% trans "Save" %}" />
                </div>
            </form>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script language="javascript">
    $(document).ready(function() {
        $('.btn-gear .remove').live('click', function(event) {
            event.preventDefault();

            var $link = $(this);
            var $btn = $link.closest('.btn-gear');
            var id = $btn.attr('id');

            $.ajax({
                url: '/profile/edit/gear/remove/' + id + '/',
                dataType: 'json',
                timeout: 10000,
                cache: false,
                type: 'POST',
                success: function() {
                    $link.tooltip('hide');
                    $btn.remove();
                }
            });
        });

        $('.btn-gear .edit').live('click', function(event) {
            event.preventDefault();

            var $btn_gear = $(this).closest('.btn-gear');
            var id = $btn_gear.attr('id');

            $.ajax({
                url: '/get_edit_gear_form/' + id + '/',
                dataType: 'json',
                timeout: 10000,
                cache: false,
                success: function(data, textStatus, XMLHttpRequest) {
                    var $dlg = $('#edit-gear-modal');
                    var $form = $dlg.find('form.global');

                    $form.find('.form-content').html(data['form']);
                    $form.find('.btn-primary').val("{% trans "Save" %}");
                    $form.find('input[name=gear_id]').val(id);

                    $form.find('input, select').bind('change keyup', function(event) {
                        var $btn = $form.find('.btn-primary')
                        $btn.val("{% trans "Save" %}");
                    });

                    $form.find('.close-modal').click(function(event) {
                        $dlg.modal('hide');
                    });

                    var ajaxFormOptions = {
                        dataType: 'json',
                        beforeSubmit: function(formData, $form, options) {
                            var $btn = $form.find('.btn-primary')
                            $btn.addClass('disabled');
                            $btn.val("...");
                        },
                        success: function(responseJson, statusText, xhr, $form) {
                            var $btn = $form.find('.btn-primary')
                            $btn.removeClass('disabled');

                            if (responseJson['success']) {
                                $btn.val("{% trans "Form saved. Thank you!" %}");

                                $btn_gear.find('.make').text($form.find('input[name=make]').val());
                                $btn_gear.find('.name').text($form.find('input[name=name]').val());

                                $.ajax({
                                    url: '/get_is_gear_complete/' + id + '/',
                                    dataType: 'json',
                                    timeout: 10000,
                                    cache: false,
                                    success: function(data, textStatus, XMLHttpRequest) {
                                        if (data['complete'])
                                            $btn_gear.removeClass('incomplete');
                                        else
                                            $btn_gear.addClass('incomplete');
                                    }
                                });
                            } else {
                                $form.find('.form-content').html(responseJson['form']);
                                $btn.val("{% trans "Save" %}");
                            }

                        },
                        error: function(responseText, statusText, xhr, $form) {
                            var $btn = $form.find('.btn-primary')
                            $btn.removeClass('disabled');
                            $btn.val("{% trans "Save" %}");
                        }
                    };

                    $form.ajaxForm(ajaxFormOptions);
                },
                error: function(XmlHttpRequest, textStatus, errorThrown) {
                    alert("Error: " + textStatus);
                }
            });

            $.ajax({
                url: '/get_gear_user_info_form/' + id + '/',
                dataType: 'json',
                timeout: 10000,
                cache: false,
                success: function(data, textStatus, XMLHttpRequest) {
                    var $dlg = $('#edit-gear-modal');
                    var $form = $dlg.find('form.custom');

                    $form.find('.form-content').html(data['form']);
                    $form.find('input[name=gear_id]').val(id);

                    $form.find('input, select').bind('change keyup', function(event) {
                        var $btn = $form.find('.btn-primary')
                        $btn.val("{% trans "Save" %}");
                    });

                    $form.find('.close-modal').click(function(event) {
                        $dlg.modal('hide');
                    });

                    var ajaxFormOptions = {
                        dataType: 'json',
                        timeout: 10000,
                        cache: false,
                        beforeSubmit: function(formData, $form, options) {
                            var $btn = $form.find('.btn-primary')
                            $btn.addClass('disabled');
                            $btn.val("...");
                        },
                        success: function(responseJson, statusText, xhr, $form) {
                            var $btn = $form.find('.btn-primary')
                            $btn.removeClass('disabled');
                            $btn.val("{% trans "Form saved. Thank you!" %}");

                            if (responseJson['success']) {
                                var alias = $form.find('input[name=alias]').val();
                                if (alias != '')
                                    $btn_gear.find('.alias').text('(' + alias + ')');
                            } else {
                                $form.find('.form-content').html(responseJson['form']);
                            }
                        },
                        error: function(responseText, statusText, xhr, $form) {
                            var $btn = $form.find('.btn-primary')
                            $btn.removeClass('disabled');
                            $btn.val("{% trans "Save" %}");
                        }
                    };

                    $form.ajaxForm(ajaxFormOptions);
                },
                error: function(XmlHttpRequest, textStatus, errorThrown) {
                    alert("Error: " + textStatus);
                }
            })

            return false;
        });

        $('.add-gear').click(function(event) {
            var $add_btn = $(this);
            var gear_type = $add_btn.attr('data-klass');

            $.ajax({
                url: '/get_empty_edit_gear_form/' + gear_type + '/',
                dataType: 'json',
                timeout: 10000,
                cache: false,
                success: function(data, textStatus, XMLHttpRequest) {
                    var $dlg = $('#add-gear-modal'),
                        $form = $dlg.find('form');

                    $form.find('.form-content').html(data['form']);
                    $form.find('.btn-primary').val("{% trans "Save" %}");

                    var $make = $form.find('input[name=make]'),
                        $name = $form.find('input[name=name]');

                    $form.find('.form-content').append(
                        '<input type="hidden" name="gear_type" value="' + gear_type + '" />');

                    $make.attr('data-provide', 'typeahead');
                    $make.attr('data-source', '{{all_gear_makes|safe|addslashes}}');
                    $make.attr('autocomplete', 'off');

                    $name.attr('data-provide', 'typeahead');
                    $name.attr('data-source', '{{all_gear_names|safe|addslashes}}');
                    $name.attr('autocomplete', 'off');

                    $name.focus(function(e) {
                        var make = $.trim($make.val());
                        if (make != '') {
                            $.ajax({
                                url: '/get-gear-by-make/' + make + '/',
                                dataType: 'json',
                                timeout: 10000,
                                cache: true,
                                success: function(data, textStatus, XMLHttpRequest) {
                                    var typeahead = $name.typeahead();
                                    typeahead.data('typeahead').source = data;
                                }
                            });
                        }
                    });

                    var ajaxFormOptions = {
                        dataType: 'json',
                        timeout: 10000,
                        cache: false,
                        beforeSubmit: function(formData, $form, options) {
                            var $btn = $form.find('input[name=save]')
                            $btn.addClass('disabled');
                            $btn.val("...");
                        },
                        success: function(responseJson, statusText, xhr, $form) {
                            var $btn = $form.find('input[name=save]')
                            $btn.removeClass('disabled');
                            $btn.val("{% trans "Save" %}");

                            if (responseJson['success']) {
                                $dlg.modal('hide');

                                var template = '\
                                    <div class="btn btn-gear">\
                                        <div class="labels">\
                                            <div class="make"></div>\
                                            <div class="name"></div>\
                                            <div class="alias"></div>\
                                        </div>\
                                        <div class="actions">\
                                            <a href="#" class="remove" rel="tooltip" title="{% trans "Remove" %}">\
                                                <i class="icon-trash"></i>\
                                            </a>\
                                            <a href="#edit-gear-modal" class="edit" data-toggle="modal" rel="tooltip" title="{% trans "Edit" %}">\
                                                <i class="icon-pencil"></i>\
                                            </a>\
                                            <a href="#" class="page" rel="tooltip" title="{% trans "View page" %}">\
                                                <i class="icon-info-sign"></i>\
                                            </a>\
                                        </div>\
                                    </div>'
                                var $new_button = $(template);
                                $new_button.attr('id', responseJson['id']);
                                $new_button.find('.make').text(responseJson['make']);
                                $new_button.find('.name').text(responseJson['name']);
                                $new_button.find('.alias').text('(' + responseJson['alias'] + ')');
                                $new_button.find('.page').attr('href', '/gear/' + responseJson['id'] + '/');

                                if(responseJson['complete'] == false) {
                                    $new_button.addClass('incomplete');
                                }

                                var $content = $add_btn.closest('.list-gear').find('.content');
                                $content.find('.no-gear').remove();
                                $content.append($new_button);
                            } else {
                                $form.find('.form-content').html(responseJson['form']);

                                $form.find('.form-content').append(
                                    '<input type="hidden" name="gear_type" value="' + gear_type + '" />');
                                $form.find('input[name=make]').attr('data-provide', 'typeahead');
                                $form.find('input[name=make]').attr('data-source', '{{all_gear_makes|safe|addslashes}}');

                                $form.find('input[name=name]').attr('data-provide', 'typeahead');
                                $form.find('input[name=name]').attr('data-source', '{{all_gear_names|safe|addslashes}}');

                                if (responseJson.gear_id) {
                                    $form.find('.form-content').append(
                                        '<input type="hidden" name="gear_id" value="' + responseJson.gear_id + '" />');
                                }

                                if (responseJson.type == 'gear_type_missing') {
                                    alert(responseJson.error);
                                }
                            }

                        },
                        error: function(responseText, statusText, xhr, $form) {
                            var $btn = $form.find('input[name=save]')
                            $btn.removeClass('disabled');
                            $btn.val("{% trans "Save" %}");
                        }
                    };

                    $form.ajaxForm(ajaxFormOptions);
                },
                error: function(XmlHttpRequest, textStatus, errorThrown) {
                    alert("Error: " + textStatus);
                }
            });
        });
    });
    </script>
{% endblock %}


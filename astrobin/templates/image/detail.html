{% extends 'base.html' %}
{% load i18n %}
{% load common_tags %}
{% load tags %}
{% load hitcount_tags %}
{% load markup %}
{% load bootstrap_toolkit %}
{% load avatar_tags %}

{% block extra_gaq_push %}
    {% if image.is_wip %}
        _gaq.push(['_setCustomVar', 3, 'Staging Image', 'Yes']);
    {% endif %}
{% endblock %}

{% block title %}AstroBin - {{image.title}} ({{image.user}}){% endblock %}
{% block content %}
    {% ifequal request.user image.user %}
    {% if image.is_wip %}
    <div class="alert alert-info">
        <p>
        {% url image_promote image.id as promote_url %}
        {% url me as profile_url %}
        {% blocktrans %}This image is a <strong>work in progress</strong> from your <a href="{{profile_url}}?staging">Staging Area</a>. This means nobody can see it unless you give them one of the links you can find in the <em>Share</em> menu below. Use that link to post this image to Internet forums and get feedback on it. When you are satisfied, perhaps after uploading some revisions, <a href="{{promote_url}}">promote it</a> to the <a href="{{profile_url}}">Public Area</a>.{% endblocktrans %}
        </p>
    </div>
    {% endif %}
    {% endifequal %}

    <div class="subnav subnav-fixed">
        <ul class="nav nav-pills">
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-bolt icon-white"></i>
                    {% trans "Actions" %}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% if request.user == image.user or request.user.is_superuser %}
                    <li>
                        <a href="{% url image_edit_basic image.id %}">
                            <i class="icon-edit"></i>
                            {% trans "Edit basic information" %}
                        </a>
                    </li>
                    {% if image.subject_type < 500 %}
                        <li>
                            <a href="{% url image_edit_gear image.id %}">
                                <i class="icon-cog"></i>
                                {% trans "Edit gear used" %}
                            </a>
                        </li>
                        <li>
                            <a href="{% url image_edit_acquisition image.id %}">
                                <i class="icon-time"></i>
                                {% trans "Edit acquisition details" %}
                            </a>
                        </li>
                    {% endif %}
                    {% if not is_final %}
                    <li>
                        {% if is_revision %}
                        <a href="{% url image_edit_revision_make_final revision_image.id %}">
                        {% else %}
                        <a href="{% url image_edit_make_final image.id %}">
                        {% endif %}
                            <i class="icon-ok"></i>
                            {% trans "Mark this revision as final" %}
                        </a>
                    </li>
                    {% endif %} <!-- not is_final -->
                    <li class="divider"></li>
                    <li>
                        <a href="{% url image_edit_license image.id %}">
                            <i class="icon-legal"></i>
                            {% trans "Change license" %}
                        </a>
                    </li>
                    <li{% if not image.is_stored %} class="disabled"{% endif %}>
                        <a class="upload-revision" href="#">
                            <i class="icon-upload-alt"></i>
                            {% trans "Upload new revision" %}
                        </a>
                    </li>
                    {% if image.subject_type == 100 or image.subject_type == 300 %}
                        {% if not image.is_solved and not is_revision %}
                        <li>
                            <a class="plate-solve" href="{% url image_edit_presolve image.id %}{% query_string "done_later=" "plate_solving_started" %}">
                                <i class="icon-screenshot"></i>
                                {% trans "Plate-solve" %}
                            </a>
                        </li>
                        {% else %}
                        <li>
                            <a class="plate-solve" href="{% url image_edit_presolve image.id %}{% query_string "done_later=" "plate_solving_started" %}">
                                <i class="icon-screenshot"></i>
                                {% trans "Plate-solve again" %}
                            </a>
                        </li>
                        {% endif %} <!-- not image.is_solved and not is_revision -->
                    {% endif %} <!-- image is deep sky or wide field -->
                    {% if image.is_wip %}
                    <li>
                        <a href="{% url image_promote image.id %}{% query_string "" "plate_solving_started" %}">
                            <i class="icon-unlock"></i>
                            {% trans "Promote to public area" %}
                        </a>
                    </li>
                    {% else %}
                    <li>
                        <a href="{% url image_demote image.id %}{% query_string "" "plate_solving_started" %}">
                            <i class="icon-lock"></i>
                            {% trans "Move to staging area" %}
                        </a>
                    </li>
                    {% endif %} <!-- image.is_wip -->

                    <li class="divider"></li>
                    <li>
                        <a data-toggle="modal" href="#send-to-datapool-modal">
                            <i class="icon-plus-sign"></i>
                            {% trans "Send to public data pool" %}
                        </a>
                    </li>

                    <li>
                        <a data-toggle="modal" href="#send-to-sharedfolder-modal">
                            <i class="icon-plus-sign"></i>
                            {% trans "Send to private shared folder" %}
                        </a>
                    </li>

                    <li class="divider"></li>
                    <li>
                    {% if not is_revision %}
                        {% if revisions %}
                        <a class="delete-original danger" href="{% url image_delete_original image.id %}">
                            <i class="icon-remove"></i>
                            {% trans "Delete original image" %}
                        </a>
                        {% else %}
                        <a class="delete-everything danger" href="{% url image_delete image.id %}">
                            <i class="icon-remove"></i>
                            {% trans "Delete everything" %}
                        </a>
                        {% endif %} <!-- revisions -->
                    {% else %}
                        <a class="delete-revision danger" href="{% url image_delete_revision image.id %}">
                            <i class="icon-remove"></i>
                            {% trans "Delete this revision" %}
                        </a>
                    {% endif %} <!-- not is_revision -->
                    </li>
                    {% endif %} <!-- owner or superuser -->
                    <li class="divider"></li>
                    <li>
                        <a href="{% url bring_to_attention image.id %}">
                            <i class="icon-retweet"></i>
                            {% trans "Bring to a user's attention" %}
                        </a>
                    </li>
                    {% if request.user != image.user %}
                    <li>
                        <a href="{% url image_request_additional_information image.id %}">
                            <i class="icon-info-sign"></i>
                            {% trans "Request additional information" %}
                        </a>
                    </li>
                    <li>
                        <a href="{% url image_request_fits image.id %}">
                            <i class="icon-file"></i>
                            {% trans "Request TIFF/FITS" %}
                        </a>
                    </li>
                    {% endif %} <!-- not owner -->
                    {% if is_ready and image.subject_type == 100 or image.subject_type == 300 %}
                    <li class="divider"></li>
                    <li>
                        <a class="messier-nomination" href="{% url messier_nomination image.id %}">
                            <i class="icon-book"></i>
                            {% trans "Nominate for the Messier Marathon" %}
                        </a>
                    </li>
                    {% endif %} <!-- is_ready -->
                 </ul>
             </li> <!-- actions -->
             <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-eye-open icon-white"></i>
                    {% trans "View" %}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% if not inverted and not solved %}
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                <i class="icon-adjust"></i>
                                {% trans "Inverted monochrome" %}
                            </a>
                        </li>
                        {% if image.is_solved and not solved %}
                        <li>
                            {% if is_revision %}
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved', r=0" "plate_solving_started" %}">
                                <i class="icon-screenshot"></i>
                                {% trans "Annotated (original version)" %}
                            </a>
                            {% else %} <!-- is_revision -->
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved'" "plate_solving_started" %}">
                                <i class="icon-screenshot"></i>
                                {% trans "Annotated" %}
                            </a>
                            {% endif %} <!-- is_revision -->
                        </li>
                        {% endif %} <!-- is_solved and not showing solved -->
                    {% endif %} <!-- not showing inverted and not showing solved -->

                    {% if inverted %}
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='none'" "plate_solving_started" %}">
                                <i class="icon-picture"></i>
                                {% trans "Normal" %}
                            </a>
                        </li>
                        {% if image.is_solved and not solved %}
                        <li>
                            {% if is_revision %}
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved', r=0" "plate_solving_started" %}">
                                <i class="icon-screenshot"></i>
                                {% trans "Annotated (original version)" %}
                            </a>
                            {% else %} <!-- is_revision -->
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved'" "plate_solving_started" %}">
                                <i class="icon-screenshot"></i>
                                {% trans "Annotated" %}
                            </a>
                            {% endif %} <!-- is_revision -->
                        </li>
                        {% endif %} <!-- is_solved and not showing solved -->
                    {% endif %} <!-- showing inverted -->

                    {% if solved %}
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='none'" "plate_solving_started" %}">
                                <i class="icon-picture"></i>
                                {% trans "Normal" %}
                            </a>
                        </li>
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                <i class="icon-adjust"></i>
                                {% trans "Inverted monochrome" %}
                            </a>
                        </li>
                    {% endif %} <!-- showing solved -->
                </ul>
            </li> <!-- view -->

            {% if request.user != image.user %}
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    <i class="icon-user icon-white"></i>
                    {% trans "User" %}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li>
                        <a href="{% url user_page image.user %}">
                            <i class="icon-user"></i>
                            {% trans "View profile" %}
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li>
                        <a class="{% if follows %}unfollow{% else %}follow{% endif %}"
                           href="{% if follows %}{% url unfollow image.user %}{% else %}{% url follow image.user %}{% endif %}{% query_string "next=request.path" "plate_solving_started" %}">
                            {% if follows %}
                                <i class="icon-eye-close"></i>
                                {% trans "Stop following" %}
                            {% else %}
                                <i class="icon-eye-open"></i>
                                {% trans "Follow" %}
                            {% endif %}
                        </a>
                    </li>
                    {% endif %} <!-- authenticated -->
                    <li>
                        <a class="send-private-message" href="{% url messages_compose_to image.user.username %}{% query_string "next=request.path, subject=image.title" "" %}">
                            <i class="icon-envelope"></i>
                            {% trans "Send private message" %}
                        </a>
                    </li>
                </ul>
            </li> <!-- user -->
            {% endif %} <!-- not owner -->

            <li>
                <a data-toggle="modal" href="#share-modal">
                    <i class="icon-share icon-white"></i>
                    {% trans "Share" %}
                </a>
            </li>
        </ul> <!-- nav -->
    </div> <!-- subnav -->

    <div class="row"> <!-- main pane -->
        <div class="span8">
            <div class="row"> <!-- the image's row -->
                <div class="span8">
                    <div class="main-image">
                        <div class="main-image-inner">
                            {% if is_ready %}
                                {% if is_revision %}
                                    {% with revision_image as image %}
                                        {% if inverted %}
                                        <a class="zoomable" href="{% url image_full image.image.id image.label %}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                            <img src="{% get_image_path image 1 1 %}" alt="{{image.title|escape}}"/>
                                        </a>
                                        {% endif %}
                                        {% if not inverted and not solved %}
                                        <a class="zoomable" href="{% url image_full image.image.id image.label %}{% query_string "" "mod, plate_solving_started" %}">
                                            <img src="{% get_image_path image 1 0 %}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                        </a>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    {% if inverted %}
                                        <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                            <img src="{% get_image_path image 1 1 %}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                        </a>
                                        {% if image.is_solved and image.plot_is_overlay %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                                <img class="plot-overlay" src="{{IMAGES_URL}}{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}" style="left:{{plot_overlay_left}}px"/>
                                            </a>
                                        {% endif %}
                                    {% endif %}

                                    {% if solved %}
                                        {% if image.plot_is_overlay %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img src="{% get_image_path image 1 0 %}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                            </a>
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img class="fixed-plot-overlay" src="{{IMAGES_URL}}{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" style="left:{{plot_overlay_left}}px"/>
                                            </a>
                                        {% else %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img src="{{IMAGES_URL}}{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}" />
                                            </a>
                                        {% endif %}
                                    {% endif %}

                                    {% if not inverted and not solved %}
                                        <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                            <img src="{% get_image_path image 1 0 %}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                        </a>
                                        {% if image.is_solved and image.plot_is_overlay %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img class="plot-overlay" src="{{IMAGES_URL}}{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}" style="left:{{plot_overlay_left}}px"/>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% else %} <!-- not ready -->
                            <div class="alert alert-warning">
                                {% blocktrans %}This image was just uploaded and is still processing. Please try to refresh this page in a few seconds.{% endblocktrans %}
                            </div>
                            {% endif %}
                        </div> <!-- main-image-inner -->
                    </div> <!-- main-image -->
                </div> <!-- span8 -->
            </div> <!-- the image's row -->

            <div class="image-title">
                <div class="row">
                    <div class="span8">
                        <h3 class="image-title">{{image.title|escape|default:_("(no title)")}}</h3>
                    </div>
                </div>

                {% if image.link %}
                <div class="row">
                    <div class="span8">
                        <strong>{% trans "Link" %}</strong>: <a href="{{image.link}}" target="_blank">{{image.link}}</a>
                    </div>
                </div>
                {% endif %}

                {% if image.link_to_fits %}
                <div class="row">
                    <div class="span8">
                        <strong>{% trans "Link to TIFF/FITS" %}</strong>: <a href="{{image.link_to_fits}}" target="_blank">{{image.link_to_fits}}</a>
                    </div>
                </div>
                {% endif %}

                <div class="row">
                    <div class="span8">
                        {% if image.subject_type == 100 or image.subject_type == 200 %}
                            <strong>{% trans "Contains" %}:</strong>
                            {% if solar_system_main_subject >= 0 %}
                                <a href="/search/?q=&amp;ssms={{solar_system_main_subject_id}}{% search_form_query %}">{{solar_system_main_subject}}</a>{% if subjects_short %},{% endif %}
                            {% endif %}
                            {% for s in subjects_short %}
                                <a {% if s.oid != -999 %}rel="popover" class="subject-popover" data-load="{% url subject_popover_ajax s.id %}"{% endif %} href="/search/?q={{s.mainId}}{% search_form_query %}">{{s.mainId|escape|cut:"NAME "|lower|capfirst}}</a>{% if not forloop.last %},{% endif %}
                            {% endfor %}
                            {% if subjects_all|length > subjects_limit %}
                                <span id="more-subjects">
                                    <span class="reminder">
                                        ,&nbsp;
                                        {% for s in subjects_reminder %}
                                            <a {% if s.oid != -999 %}rel="popover" class="subject-popover" data-load="{% url subject_popover_ajax s.id %}"{% endif %} href="/search/?q={{s.mainId}}{% search_form_query %}">{{s.mainId|escape|cut:"NAME "|lower|capfirst}}</a>{% if not forloop.last %},{% endif %}
                                        {% endfor %}
                                    </span>
                                    <span class="more">
                                        &#8230;&nbsp;
                                        <a href="#">
                                            <em>
                                               {% blocktrans with subjects_reminder|length as number %}and {{number}} more (click to view).{% endblocktrans %}
                                            </em>
                                        </a>
                                    </span>
                                    <span class="hide">
                                        <a href="#">
                                            &nbsp;
                                            <em>
                                               {% blocktrans %}(hide these subjects){% endblocktrans %}
                                            </em>
                                        </a>
                                    </span>
                                </span>
                            {% endif %}
                        {% else %}
                            {% if image.subject_type != 600 %}
                                <strong>{% trans "Subject type" %}:</strong> {{subject_type}}
                            {% endif %}
                        {% endif %}
                    </div> <!-- span8 -->
                </div>
            </div>

            {% if image.subject_type < 500 %}
            <div class="row image-detail">
                <div class="span8">
                    <div class="subtle-container image-detail-inner">
                        <div class="header">
                            <h4><i class="icon-list-alt"></i> {% trans "Technical card" %}</h4>
                        </div>
                        <div class="gear">
                            <div class="gear-inner">
                                {% for i in gear_list %}
                                    {% if i.1 %}
                                        <p>
                                          <strong>{% trans i.0 %}:</strong>
                                          {% for g in i.1 %}
                                                <a rel="popover" class="gear-popover{% if g.commercial and g.commercial.is_paid or g.commercial.producer == request.user %} btn btn-mini btn-warning{% endif %}" data-load="{% url gear_popover_ajax g.id %}" href="{% url gear_page g.id g.slug %}">{% gear_name g %}</a>{% if not forloop.last %},&nbsp;{% endif %}
                                            {% endfor %}
                                        </p>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div> <!-- gear -->

                        <div class="acquisition">
                            <div class="acquisition-inner">
                                {% if image_type == 'deep_sky' %}
                                    {% for data in deep_sky_data %}
                                        {% if data.1 %}
                                            <p>
                                                <strong>{{data.0}}</strong>:
                                                {% if data.0 == dates_label %}
                                                    {% for date in data.1 %}
                                                        <a href="/search/{% query_string "q=, start_date=date, end_date=date" "plate_solving_started, r, mod" %}{% search_form_query %}">{{date|date:"DATE_FORMAT"}}</a>{% if not forloop.last %},&nbsp;{% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {{data.1|safe|linebreaksbr}}
                                                {% endif %}
                                            </p>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    {% if ssa.date %}
                                        <p><strong>{% trans "Date" %}</strong>: <a href="/search/{% query_string "q=, start_date=ssa.date, end_date=ssa.date" "plate_solving_started, r, mod" %}{% search_form_query %}">{{ssa.date|date:"DATE_FORMAT"}}</a></p>
                                    {% endif %}
                                    {% if ssa.time %}
                                        <p><strong>{% trans "Time" %}</strong>: {{ssa.time}}</p>
                                    {% endif %}
                                    {% if ssa.frames %}
                                        <p><strong>{% trans "Frames" %}</strong>: {{ssa.frames}}</p>
                                    {% endif %}
                                    {% if ssa.fps %}
                                        <p><strong>{% trans "FPS" %}</strong>: {{ssa.fps}}</p>
                                    {% endif %}
                                    {% if ssa.focal_length %}
                                        <p><strong>{% trans "Focal length" %}</strong>: {{ssa.focal_length}}</p>
                                    {% endif %}
                                    {% if ssa.cmi %}
                                        <p><strong>{% trans "CMI" %}</strong>: {{ssa.cmi}}</p>
                                    {% endif %}
                                    {% if ssa.cmii %}
                                        <p><strong>{% trans "CMII" %}</strong>: {{ssa.cmii}}</p>
                                    {% endif %}
                                    {% if ssa.cmiii %}
                                        <p><strong>{% trans "CMIII" %}</strong>: {{ssa.cmiii}}</p>
                                    {% endif %}
                                    {% if ssa.seeing %}
                                        <p><strong>{% trans "Seeing" %}</strong>: {{ssa.seeing}}</p>
                                    {% endif %}
                                    {% if ssa.transparency %}
                                        <p><strong>{% trans "Transparency" %}</strong>: {{ssa.transparency}}</p>
                                    {% endif %}
                                {% endif %}

                                {% if image.is_solved and image.ra_center_hms %}
                                    <p><strong>{% trans "RA center" %}</strong>: {{image.ra_center_hms}}</p>
                                    <p><strong>{% trans "DEC center" %}</strong>: {{image.dec_center_dms}}</p>
                                    {% if image.pixscale != 0 %}
                                        <p><strong>{% trans "Pixel scale" %}</strong>: {{image.pixscale|cut_decimals:"2"}} {% trans "arcsec/pixel" %}</p>
                                    {% endif %}
                                    <p><strong>{% trans "Orientation" %}</strong>: {{image.orientation|cut_decimals:"2"}} {% trans "degrees" %}</p>
                                    <p><strong>{% trans "Field width" %}</strong>: {{image.fieldw|cut_decimals:"2"}} {% if image.fieldunits == 'degrees' %}{% trans "degrees" %}{% else %}{% if image.fieldunits == 'arcminutes' %}{% trans 'arcminutes' %}{% endif %}{% endif %}</p>
                                    <p><strong>{% trans "Field height" %}</strong>: {{image.fieldh|cut_decimals:"2"}} {% if image.fieldunits == 'degrees' %}{% trans "degrees" %}{% else %}{% if image.fieldunits == 'arcminutes' %}{% trans 'arcminutes' %}{% endif %}{% endif %}</p>
                                {% endif %}
                            </div> <!-- acquisition-inner -->
                        </div> <!-- acquisition -->
                    </div> <!-- image-detail-inner -->
                </div> <!-- span8 -->
            </div> <!-- row image-detail -->
            {% endif %} {# image.subject_type < 500 #}

            {% if image.description %}
            <div class="image-description row">
                <div class="span8">
                    <div class="subtle-container">
                        <div class="header"><h4><i class="icon-align-left"></i> {% trans "Description" %}</h4></div>
                        {{image.description|safe|linebreaks}}
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="row">
                <div class="span8">
                    <div class="subtle-container">
                        <div class="header"><h4><i class="icon-comments-alt"></i> {% trans "Comments" %}</h4></div>
                        {% if user.is_authenticated %}
                        <p>
                            {% blocktrans with user=image.user lang=preferred_language %}<strong>Leave a comment here</strong>, and remember that AstroBin is an international community: using English is preferred. PS: <strong>{{user}}</strong>'s preferred language is <strong>{{lang}}</strong>.{% endblocktrans %}
                        </p>
                        {% endif %}

                        <div id="nested-comments"
                             data-content-type-id="{{content_type.pk}}"
                             data-object-id="{{image.pk}}">
                        </div>
                        {% include 'nested_comments/nestedcomment_app.html' %}

                    </div> <!-- subtle-container -->
                </div> <!-- span8 -->
            </div> <!-- row -->
        </div> <!-- span8 -->

        <div class="span4"> <!-- right pane -->
            {% ifequal request.user image.user %}
            <div class="subtle-container">
                <a href="http://questions.astrobin.com/questions/ask/?title=How%20can%20I%20improve%20this%20image?%20({{image.title|escape}})&text=!%5B{{image.title|escape}}%5D({{IMAGES_URL}}{{image.filename}}_resized{{image.original_ext}})%0A%0A%5B(View%20full%20size%20on%20AstroBin)%5D(http://astrob.in/full/{{image.id}}/)%0A%0A%0AREMEMBER%20TO%20EDIT%20THIS%20PART!%0A%0A%0AThank%20you!&tags=critique-request"
                   target="_blank"
                   id="request-critique"
                   data-title="{% trans "What is this?" %}"
                   data-content="{% blocktrans %}This button will create a post on AstroBin Questions, in which you can ask for critique, review or analysis of your image.{% endblocktrans %} <a href='{% url help_questions %}'>{% trans "Learn more about AstroBin Questions." %}</a>"
                   class="btn btn-primary btn-large"
                   style="width:242px; font-weight: bold; font-size: 22px">
                   {% trans "Request critique" %}
                </a>
            </div>
            {% endifequal %}

            {% if request.user.is_authenticated %}
            <div class="community-bulletin">
                <h4>{% trans "Introducing AstroBin Raw Data" %}</h4>
                <p>
                    {% url rawdata.help1 as rawdata_url %}
                    {% blocktrans %}<strong>AstroBin Raw Data</strong> is a platform for the secure storage of all your FIT and DLSR raw files, up to 500 GB! It will automatically keep your files organized, and allow you to share them with other members. <a href="{{rawdata_url}}">Want to know more?</a>{% endblocktrans %}
                </p>
            </div>
            {% endif %}

            {% if revisions or is_revision %}
            <div class="subtle-container">
                <ul class="thumbnails astrobin-thumbnails">
                    <li class="thumbnail astrobin-thumbnail revisions" style="width:86px">
                        <div class="revision">
                            {% if is_revision %}
                                <a href="{% url image_detail image.id 0 %}">
                            {% else %}
                                <div class="overlay"></div>
                            {% endif %}
                                {% if image.is_final %}
                                    <div class="final">
                                        <span class="text">
                                            {% trans "Final" %}
                                        </span>
                                    </div>
                                {% endif %}
                                <div class="image">
                                    <img src="{% if image.is_stored %}{{IMAGES_URL}}{{image.filename}}_small_thumb{{image.original_ext}}{% else %}{{STATIC_URL}}icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="" width="86" height="86"/>
                                </div>
                                <div class="label">
                                    {% trans "Original" %}
                                </div>
                            </div>
                        {% if is_revision %}
                            </a>
                        {% endif %}
                    </li>
                    {% for i in revisions %}
                    <li class="thumbnail astrobin-thumbnail revisions" style="width:86px">
                        <div class="revision">
                            {% if i != revision_image %}
                                <a href="{% url image_detail i.image.id i.label %}">
                            {% else %}
                                <div class="overlay"></div>
                            {% endif %}
                                {% if i.is_final %}
                                    <div class="final">
                                        <span class="text">
                                            {% trans "Final" %}
                                        </span>
                                    </div>
                                {% endif %}
                                <div class="image">
                                    <img src="{% if image.is_stored %}{{IMAGES_URL}}{{i.filename}}_small_thumb{{i.original_ext}}{% else %}{{STATIC_URL}}icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="" width="86" height="86"/>
                                </div>
                                <div class="label">
                                    {{i.label}}
                                </div>
                            {% if i != revision_image %}
                                </a>
                            {% endif %}
                        </div>
                    </li>
                    {% endfor %}
                </ul> <!-- thumbnails -->
            </div> <!-- subtle-container -->
            {% endif %}



            <div class="subtle-container avatar-block">
                <div class="avatar">
                    <a href="{% url user_page image.user %}">
                        {% avatar image.user 86 %}
                    </a>
                </div>
                <div class="username">
                    <a rel="tooltip" title="{{image.user.username}}" href="{% url user_page image.user %}">{{image.user.username|truncatechars:18}}</a>
                </div>
            </div>

            <div class="subtle-container">
                <div class="favorite-container">
                    <a href="{% if request.user.is_authenticated %}#{% else %}/accounts/login/?next={{request.path}}{% endif %}" class="btn btn-danger favorite" rel="tooltip" title="{% if already_favorited %}{% trans "Remove from favorites" %}{% else %}{% trans "Mark as favorite" %}{% endif %}">
                        {% if already_favorited %}
                            <div style="font-size: 32px; color: #FFA040;">
                        {% else %}
                            <div style="font-size: 32px;">
                        {% endif %}
                            <i class="icon-heart"></i>
                        </div>
                    </a>
                </div>

                {% if image.allow_rating %}
                    <div id="rating"></div>
                {% endif %}
            </div> <!-- subtle-container -->

            <div class="subtle-container image-basic-data">
                <table class="table">
                    <tr>
                        <th><div style="font-size: 16px"><i class="icon-legal"></i></div></th>
                        <td>
                            <a target="_blank" href="http://creativecommons.org/licenses/">
                                <img class="license"
                                     src="{{STATIC_URL}}icons/{{license_icon}}"
                                     alt="{% trans "License" %}: {{license_title}}"
                                     title="{% trans "License" %}: {{license_title}}" />
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th><div style="font-size: 16px"><i class="icon-calendar"></i></div></th>
                        <td>{{uploaded_on|ago}}</td>
                    </tr>
                    <tr>
                        {% get_hit_count for image as hit_count %}
                        <th><div style="font-size: 16px"><i class="icon-eye-open"></i></div></th>
                        <td>{{hit_count}}</td>
                    </tr>
                    <tr>
                        <th><div style="font-size: 16px"><i class="icon-heart"></i></div></th>
                        <td><span class="favorites-number">{{times_favorited}}</span></td>
                    </tr>
                    <tr>
                        <th><div style="font-size: 16px"><i class="icon-star"></i></div></th>
                        <td>
                            <a href="#" class="current-rating rating-popover"
                               rel="popover" data-load="{% url rating_popover_ajax image.id %}">
                                {% if votes_number > 0 %}{{index|floatformat:3}}{% else %}0.000{% endif %}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th><div style="font-size: 16px"><i class="icon-comments-alt"></i></div></th>
                        <td><span class="comments-number">{{comments_number}}</span></td>
                    </tr>
                </table>
            </div>

            {% if is_ready and not image.animated %}
                <div class="subtle-container">
                    <div class="header"><h4><i class="icon-bar-chart"></i> {% trans "Histogram" %}</h4></div>
                    <img src="{{IMAGES_URL}}{{image.filename}}_hist.png" alt="{% trans "Histogram" %}"/>
                </div>
            {% endif %}

            {% if gear_list_has_commercial and gear_list_has_paid_commercial %}
                <div class="subtle-container">
                    <div class="header"><h4><i class="icon-group"></i> {% trans "Made possible by" %}</h4></div>
                    {% for i in gear_list %}
                        {% if i.1 %}
                            {% for g in i.1 %}
                                {% if g.commercial and g.commercial.is_paid or g.commercial.producer == request.user %}
                                    <a rel="popover"
                                       class="gear-popover btn btn-mini btn-warning"
                                       data-load="{% url gear_popover_ajax g.id %}"
                                       href="{% url gear_page g.id g.slug %}">{% gear_name g %}</a>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %} {# gear_list_has_commercial #}
        </div> <!-- span -->
    </div> <!-- row  (main pane) -->
{% endblock %}

{% block modals %}
    <div class="modal hide fade" id="share-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Share" %}</h3>
        </div>
        <div class="modal-body">
            <div class="well">
                <span class='st_googleplus' displayText='Google+'></span>
                <span class='st_facebook' displayText='Facebook'></span>
                <span class='st_twitter' displayText='Twitter'></span>
            </div>

            <div class="well">
                <form class="copy">
                    <table class="table">
                        <tr>
                            <td>
                                <label for="sharing_mode">{% trans "Sharing mode" %}:</label>
                                <select id="sharing_mode" name="sharing_mode">
                                    <option selected="selected" value="0">{% trans "Simple link" %}</option>
                                    <option value="1">{% trans "Forums" %}</option>
                                    <option value="2">HTML</option>
                                </select>
                            </td>
                            <td>
                                <label for="sharing_thumbnail">{% trans "Thumbnail" %}:</label>
                                <select id="sharing_thumbnail" name="sharing_thumbnail" disabled="disabled">
                                    <option selected="selected" value="0">{% trans "Yes" %}</option>
                                    <option value="1">{% trans "No" %}</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="sharing_image_size">{% trans "Image size" %}:</label>
                                <select id="sharing_image_size" name="sharing_image_size">
                                    <option selected="selected" value="0">{% trans "Regular" %}</option>
                                    <option value="1">{% trans "Full" %}</option>
                                </select>
                            </td>
                            <td rowspan=2>
                                <label for="sharing_code">{% trans "Copy this" %}</label>
                                <div id="clip-container">
                                    <div id="clip" class="clip">
                                        <img alt="{% trans "Copy" %}" src="{{STATIC_URL}}icons/copy.png" />&nbsp;&nbsp;&nbsp;&nbsp;
                                    </div>
                                    <div class="flash-container"></div>
                                    <div class="clip-status">{% trans "Copy" %}</div>
                                </div>
                                <textarea id="sharing_code" name="sharing_code" rows=6>{% if is_revision %}http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/{% else %}http://astrob.in/{{image.id}}/{% endif %}</textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="sharing_image_mode">{% trans "Image mode" %}:</label>
                                <select id="sharing_image_mode" name="sharing_image_mode">
                                    <option selected="selected" value="0">{% trans "Normal" %}</option>
                                    <option value="1">{% trans "Inverted monochrome" %}</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>

    <div class="modal hide fade" id="send-to-datapool-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Send to public data pool" %}</h3>
        </div>
        <div class="modal-body">
            <p>
                {% blocktrans %}If this image is the result of your processing of a public data pool, you can send it the pool so it's displayed there.{% endblocktrans %}
            </p>

            {% if has_rawdata_subscription %}
                <p>
                    {% blocktrans %}Use this form to select an existing <strong>public data pool</strong>.{% endblocktrans %}
                </p>
                <form class="form-inline" id="select-datapool">
                    {{select_datapool_form|as_bootstrap}}
                </form>
            {% else %}
                <div class="alert alert-error">
                    <h4 class="alert-heading">
                        <i class="icon-fire"></i>
                        {% trans "Error!" %}
                    </h4>
                    {% url rawdata.help1 as rawdata_url %}
                    {% blocktrans %}You need a <a href="{{rawdata_url}}">Raw Data</a> subscription to perform this action.{% endblocktrans %}
                    {% blocktrans %}The <a href="{{rawdata_url}}">Raw Data Platform</a> is primarily a way to securely back up your raw files, and keep them neatly and effortlessly organized, but being part of it also means that you support AstroBin and can perhaps contribute your raw files to scientic discoveries.{% endblocktrans %}
            {% endif %}
        </div>
        <div class="modal-footer">
            {% if has_rawdata_subscription %}
                <button id="send-to-datapool" class="btn btn-primary">{% trans "Send" %}</button>
            {% else %}
                <a class="btn btn-primary" href="{% url rawdata.help1 %}">Sign up now!</a>
            {% endif %}
        </div>
    </div>

    <div class="modal hide fade" id="send-to-sharedfolder-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Send to private shared folder" %}</h3>
        </div>
        <div class="modal-body">
            <p>
                {% blocktrans %}If this image is the result of your processing of a private shared folder, you can send it the folder so it's displayed there.{% endblocktrans %}
            </p>

            {% if has_rawdata_subscription %}
                {% if has_sharedfolders %}
                    <p>
                        {% blocktrans %}Use this form to select a <strong>private shared folder</strong> you have created or have been invited to.{% endblocktrans %}
                    </p>
                    <form class="form-inline" id="select-sharedfolder">
                        {{select_sharedfolder_form|as_bootstrap}}
                    </form>
                {% else %}
                    <div class="alert alert-error">
                        <h4 class="alert-heading">
                            <i class="icon-fire"></i>
                            {% trans "Error!" %}
                        </h4>
                        {% url rawdata.help1 as rawdata_url %}
                        {% blocktrans %}You don't have access to any shared private folders.{% endblocktrans %}
                    </div>
                {% endif %}
            {% else %}
                <div class="alert alert-error">
                    <h4 class="alert-heading">
                        <i class="icon-fire"></i>
                        {% trans "Error!" %}
                    </h4>
                    {% url rawdata.help1 as rawdata_url %}
                    {% blocktrans %}You need a <a href="{{rawdata_url}}">Raw Data</a> subscription to perform this action.{% endblocktrans %}
                    {% blocktrans %}The <a href="{{rawdata_url}}">Raw Data Platform</a> is primarily a way to securely back up your raw files, and keep them neatly and effortlessly organized, but being part of it also means that you support AstroBin and can perhaps contribute your raw files to scientic discoveries.{% endblocktrans %}
                </div>
            {% endif %}
        </div>
        <div class="modal-footer">
            {% if has_rawdata_subscription %}
                {% if has_sharedfolders %}
                    <button id="send-to-sharedfolder" class="btn btn-primary">{% trans "Send" %}</button>
                {% else %}
                    <a class="close btn" data-dismiss="modal">{% trans "OK" %}</a>
                {% endif %}
            {% else %}
                <a class="btn btn-primary" href="{% url rawdata.help1 %}">Sign up now!</a>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "ur-15649ecb-6f21-a004-8032-7cf8416c478c"}); </script>
<script src="{{STATIC_URL}}nested_comments/js/nested_comments_app.js"></script>
<script type="text/javascript">
$(document).ready(function() {
    {% if request.user.is_authenticated %}
    $('a.favorite').click(function() {
        var $link = $(this),
            $heart = $link.find('i.icon-heart');

        $.ajax({
            url: '{% url favorite_ajax image.id %}',
            dataType: 'json',
            timeout: 5000,
            success: function(data, textStatus, XMLHttpRequest) {
                var color, title;
                if (data.created) {
                    color = '#FFA040';
                    title = "{% trans "Remove from favorites" %}";
                } else {
                    color = "#FFFFFF";
                    title = "{% trans "Mark as favorite" %}";
                }

                $heart.parent().css('color', color);
                $link.attr('data-original-title', title);
                $('.favorites-number').text(data.favorites);
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            }
        });

        return false;
    });
    {% endif %}

    var clip = new ZeroClipboard.Client();
    clip.setCSSEffects(false);

    clip.addEventListener('mouseOver', function() {
        $('.clip-status').show();
    });
    clip.addEventListener('mouseOut', function() {
        $('.clip-status').hide();
        $('.clip-status').text('{% trans "Copy" %}');
    });
    clip.addEventListener('complete', function() {
        $('.clip-status').text('{% trans "Copied!" %}');
    });

    clip.setText(
        {% if is_revision %}
            "http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/"
        {% else %}
            "http://astrob.in/{{image.id}}/"
        {% endif %}
    );

    var clip_html = clip.getHTML(16, 16);
    $('#clip-container .flash-container').append(clip_html);

    $('form.copy select').change(function() {
        var sharing_mode = parseInt($('select[name=sharing_mode] option:selected').val());
        var image_size = parseInt($('select[name=sharing_image_size] option:selected').val());
        var image_mode = parseInt($('select[name=sharing_image_mode] option:selected').val());
        var thumbnail = parseInt($('select[name=sharing_thumbnail] option:selected').val());
        var textarea = $('form.copy textarea');
        var content = '';

        if (sharing_mode == 0) {
            $('select[name=sharing_thumbnail]').attr('disabled', 'disabled');
            $('select[name=sharing_thumbnail]').closest('.selector').addClass('disabled');
        } else {
            $('select[name=sharing_thumbnail]').removeAttr('disabled');
            $('select[name=sharing_thumbnail]').closest('.selector').removeClass('disabled');
        }

        if (sharing_mode == 0 && image_size == 0 && image_mode == 0) {
            content =
                {% if is_revision %}
                    "http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}"
                {% else %}
                    "http://astrob.in/{{image.id}}/"
                {% endif %}
        } else
        if (sharing_mode == 0 && image_size == 0 && image_mode == 1) {
            content =
                {% if is_revision %}
                    "http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted"
                {% else %}
                    "http://astrob.in/{{image.id}}/?mod=inverted"
                {% endif %}
        } else
        if (sharing_mode == 0 && image_size == 1 && image_mode == 0) {
            content =
                {% if is_revision %}
                    "http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}"
                {% else %}
                    "http://astrob.in/full/{{image.id}}/"
                {% endif %}
        } else
        if (sharing_mode == 0 && image_size == 1 && image_mode == 1) {
            content =
                {% if is_revision %}
                    "http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted"
                {% else %}
                    "http://astrob.in/full/{{image.id}}/?mod=inverted"
                {% endif %}
        } else

        if (sharing_mode == 1 && image_size == 0 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/][IMG]{{IMAGES_URL}}{{revision_image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/][IMG]{{IMAGES_URL}}{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 0 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted][IMG]{{IMAGES_URL}}{{revision_image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/?mod=inverted][IMG]{{IMAGES_URL}}{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/][IMG]{{IMAGES_URL}}{{revision_image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/][IMG]{{IMAGES_URL}}{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted][IMG]{{IMAGES_URL}}{{revision_image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/?mod=inverted][IMG]{{IMAGES_URL}}{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 0 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/]{{image.title}} ({{revision_image.label}})[/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/]{{image.title}}[/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 0 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted]{{image.title}} ({{revision_image.label}})[/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/?mod=inverted]{{image.title}}[/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/]{{image.title}} ({{revision_image.label}})[/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/]{{image.title}}[/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted]{{image.title}} ({{revision_image.label}})[/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/?mod=inverted]{{image.title}}[/URL]"
                {% endif %}
        } else

        if (sharing_mode == 2 && image_size == 0 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/\"><img src=\"{{IMAGES_URL}}{{revision_image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/\"><img src=\"{{IMAGES_URL}}{{image.filename}}_thumb.png\"/></a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 0 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted\"><img src=\"{{IMAGES_URL}}{{revision_image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/?mod=inverted\"><img src=\"{{IMAGES_URL}}{{image.filename}}_thumb.png\"/><a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/\"><img src=\"{{IMAGES_URL}}{{revision_image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/\"><img src=\"{{IMAGES_URL}}{{image.filename}}_thumb.png\"/></a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted\"><img src=\"{{IMAGES_URL}}{{revision_image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/?mod=inverted\"><img src=\"{{IMAGES_URL}}{{image.filename}}_thumb.png\"/></a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 0 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/\">{{image.title}} ({{revision_image.label}})</a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/\">{{image.title}}</a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 0 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted\">{{image.title}} ({{revision_image.label}})</a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/?mod=inverted\">{{image.title}}</a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/\">{{image.title}} ({{revision_image.label}})</a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/\">{{image.title}}</a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/{{revision_image.label}}/?mod=inverted\">{{image.title}} ({{revision_image.label}})</a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/?mod=inverted\">{{image.title}}</a>"
                {% endif %}
        }


        clip.setText(content);
        textarea.val(content);
    });

    {% get_hit_count_javascript for image %}

    astrobin_common.init(
        '{{image.user.username}}',
        {
            follow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Follow {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will receive a notification every time {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, follow!" %}"
                },
                stop_following: "{% trans "Stop following" %}"
            },
            unfollow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Stop following {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will stop receiving notifications when {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, stop following!" %}"
                },
                follow: "{% trans "Follow" %}"
            },
            message_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Send {{username}} a message{% endblocktrans %}",
                    body  : "",
                    button: "{% trans "Send" %} &rarr;"
                },
                form_html: '{% autoescape off %}{{private_message_form.as_p|append_slash}}{% endautoescape %}',
                csrf_token: '{{csrf_token}}',
                url      : "{% url send_private_message %}"
            }
        });

    astrobin_common.setup_gear_popovers("{% trans "Follow" %}", "{% trans "Unfollow" %}");
    astrobin_common.setup_subject_popovers("{% trans "Follow" %}", "{% trans "Unfollow" %}");
    astrobin_common.setup_user_popovers("{% trans "Follow" %}", "{% trans "Unfollow" %}");
    astrobin_common.setup_rating_popovers();

    astrobin_image_detail.init(
        {{image.id}},
        {% if is_revision %}{{revision_image.id}}{% else %}0{% endif %},
        "{{image.user.username}}",
        {% if votes_number > 0 %}
        "{{index}}",
        {% else %}
        "0",
        {% endif %}
        {
            rating: {
                {% if not request.user.is_authenticated %}
                redirectUrl: "/accounts/login/?next={{request.path}}",
                {% endif %}
                {% if already_voted %}
                hint_list: [
                    "{% trans "You have already voted." %}",
                    "{% trans "You have already voted." %}",
                    "{% trans "You have already voted." %}",
                    "{% trans "You have already voted." %}",
                    "{% trans "You have already voted." %}",
                ],
                {% else %}
                hint_list: [
                    "{% trans "It's a start, but it needs better data." %}",
                    "{% trans "It looks good, but it needs better processing." %}",
                    "{% trans "Good data, good processing." %}",
                    "{% trans "Great result!" %}",
                    "{% trans "Top quality!" %}"],
                {% endif %}
                read_only: {% if request.user.is_authenticated and not already_voted and request.user != image.user %} false {% else %} true {% endif %}
            },
            upload_revision_action: {
                dialog: {
                    title: "{% trans "Upload new revision" %}",
                    body : "{% blocktrans %}Did you improve the post-processing of your image? Upload the new revision!{% endblocktrans %}"
                },
                form_html: '{% autoescape off %}{{upload_revision_form.file}}\
                            <div class="form-actions">\
                                <input class="btn btn-primary" type="submit" value="{% trans "Upload" %}" />\
                            </div>\
                            {% endautoescape %}',
                csrf_token: '{{csrf_token}}',
                fileDefaultText: "{% trans "No file selected" %}",
                fileBtnText: "{% trans "Choose file" %}",
                uploadingText: "{% trans "Uploading..." %}"
            },
            delete_action: {
                dialog: {
                    title : "{% trans "Delete image and all its revisions?" %}",
                    body  : "{% trans "The image will be permanently deleted and cannot be recovered. All its revisions will be deleted too. Are you sure?"%}",
                    button: "{% trans "Yes, delete everything" %}"
                }
            },
            delete_revision_action: {
                dialog: {
                    title : "{% trans "Delete this revision?" %}",
                    body  : "{% trans "This revision will be permanently deleted and cannot be recovered. Are you sure?"%}",
                    button: "{% trans "Yes, delete revision" %}"
                }
            },
            delete_original_action: {
                dialog: {
                    title : "{% trans "Delete original image?" %}",
                    body  : "{% trans "The image will be permanently deleted and cannot be recovered. Its revisions will not be deleted. Are you sure?"%}",
                    button: "{% trans "Yes, delete image" %}"
                }
            }
        });

        $('#request-critique').popover({
            placement: 'bottom',
            trigger: 'hover',
            delay: {hide: 2000}
        });

        $('button#send-to-datapool').click(function(e) {
            var selected = $('form#select-datapool select option:selected').val();

            $.ajax({
                type: 'post',
                dataType: 'json',
                data: {image: {{image.id}}},
                url: '/rawdata/publicdatapools/' + selected + '/add-image/',
                success: function() {
                    window.location.href = '/rawdata/publicdatapools/' + selected + '/';
                }
            });

            e.preventDefault();
        });

        $('button#send-to-sharedfolder').click(function(e) {
            var selected = $('form#select-sharedfolder select option:selected').val();

            $.ajax({
                type: 'post',
                dataType: 'json',
                data: {image: {{image.id}}},
                url: '/rawdata/privatesharedfolders/' + selected + '/add-image/',
                success: function() {
                    window.location.href = '/rawdata/privatesharedfolders/' + selected + '/';
                }
            });

            e.preventDefault();
        });
    });
</script>
{% endblock %}


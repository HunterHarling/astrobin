{% extends 'base.html' %}
{% load i18n %}
{% load tags %}

{% block title %}AstroBin - {{user}}{% endblock %}
{% block content %}
<a name="page_anchor"></a>
<div class="profile">
    <div class="full-box clear">
        <h1 class="inline profile">
            {% ifequal user request.user %}
                {% blocktrans %}View your images{% endblocktrans %}
            {% else %}
                {% blocktrans with user.username as username %}View {{username}}'s images:{% endblocktrans %}
            {% endifequal %}
        </h1>

        {% ifequal user request.user %}
        <span class="area-selection">
        (
            {% if section == 'public' %}
                {% trans "Public Area" %}
            {% else %}
                <a href="{% url me %}">{% trans "Public Area" %}</a>
            {% endif %}
            |
            {% if section == 'staging' %}
                {% trans "Staging Area" %}
            {% else %}
                <a href="?staging">{% trans "Staging Area" %}</a>
            {% endif %}
        )
        </span>
        {% endifequal %}

        {% if section == 'public' %}
        <ul class="bar">
            <li id="menu">
                <ul class="topnav">
                    {% if request.user != user and request.user.is_authenticated %}
                    <li id="user" class="first">
                        <span class="text"><a href="#">{% trans "User menu" %}</a></span>
                        <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                        <div class="sub">
                            <ul class="subnav">
                                <li class="bg-icon {% if follows %}icon-unfollow{% else %}icon-follow{% endif %}">
                                    <span class="text">
                                        <a class="{% if follows %}unfollow{% else %}follow{% endif %}"
                                           href="{% if follows %}{% url unfollow user %}{% else %}{% url follow user %}{% endif %}{% query_string "next=request.path" "plate_solving_started" %}">
                                            {% if follows %}
                                                {% trans "Stop following" %}
                                            {% else %}
                                                {% trans "Follow" %}
                                            {% endif %}
                                        </a>
                                    </span>
                                </li>
                                <li class="last bg-icon icon-message">
                                    <span class="text"><a class="send-private-message" href="{% url messages_compose_to user %}{% query_string "next=request.path" "" %}">{% trans "Send private message" %}</a></span>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}
                    <li id="sort" class="last">
                        <span class="text"><a href="#">{% trans "Sort images by" %}</a></span>
                        <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                        <div class="sub">
                            <ul class="subnav">
                                <li class="bg-icon{% if 'sub' not in request.GET or request.GET.sub == 'uploaded' %} icon-check{% endif %}">
                                    <span class="text">
                                        <a href="?public&sub=uploaded">{% trans "Upload time" %}</a>
                                    </span>
                                </li>
                                <li class="bg-icon{% if request.GET.sub == 'acquired' %} icon-check{% endif %}">
                                    <span class="text">
                                        <a href="?public&sub=acquired">{% trans "Acquisition time" %}</a>
                                    </span>
                                </li>
                                <li class="bg-icon{% if request.GET.sub == 'subject' %} icon-check{% endif %}">
                                    <span class="text">
                                        <a href="?public&sub=subject">{% trans "Subject type" %}</a>
                                    </span>
                                </li>
                                <li class="bg-icon{% if request.GET.sub == 'year' %} icon-check{% endif %}">
                                    <span class="text">
                                        <a href="?public&sub=year">{% trans "Year" %}</a>
                                    </span>
                                </li>
                                <li class="bg-icon{% if request.GET.sub == 'gear' %} icon-check{% endif %}">
                                    <span class="text">
                                        <a href="?public&sub=gear">{% trans "Gear" %}</a>
                                    </span>
                                </li>
                                <li class="bg-icon{% if request.GET.sub == 'nodata' %} icon-check{% endif %}">
                                    <span class="text">
                                        <a href="?public&sub=nodata">{% trans "Lacking data" %}</a>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        {% endif %}
        <div class="fix"></div>
        <hr/>

        {% if user == request.user and section == 'staging' %}
        <p>
            {% blocktrans %}These are your "work in progress" images: only you can see this list. You can show people individual images by sharing them using the <em>Share</em> menu.{% endblocktrans %}
        </p>
        {% endif %}

        <div class="album">
            {% if section == 'public' and not image_list %}
                {% if subsection == 'nodata' %}
                <p>
                    {% blocktrans %}These images don't have enough data. It's a shame...{% endblocktrans %}
                    {% if request.user = user %}
                        {% blocktrans %}If you want your images to be categorized in albums, you should really fill in some data. Imaging telescopes, imaging cameras and subjects are the bare minimum. Dates of acquisitions are very important too.{% endblocktrans %}
                    {% endif %}
                </p>
                {% endif %}

                {% for album in smart_albums %}
                    {% for item in album %}
                        {% for title, content in item.items %}
                            {% if content.images %}
                            <div class="album-part">
                                <h4>{{title}}</h4>
                                {% ifequal content.images|length 16 %}
                                    <span><a href="?public&sub={{subsection}}&{{subsection}}={{title}}">{% trans "(view more...)" %}</a></span>
                                {% endifequal %}
                                {% if user == request.user and content.message %}
                                <p>
                                    {{content.message|safe}}
                                </p>
                                {% endif %}
                                <div class="fix"></div>
                                {% image_list request content.images 0 %} {% comment %}0 is for False (no pagination){% endcomment %}
                                <div class="fix"></div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endfor %}
                {% empty %}
                    {% blocktrans %}No images.{% endblocktrans %}
                {% endfor %}
            {% else %}
                {% if subtitle %}
                    <h4 class="inline">{{subtitle}}</h4> 
                    {% if backlink %}
                        <span><a href="{{backlink}}">{% trans "(go back)" %}</a></span>
                    {% endif %}
                {% endif %}
                {% if subsection == 'acquired' %}
                <p>
                    {% blocktrans %}These images are ordered so that the most recently acquired appear first. Please note: images with no acquisition dates will appear last, and in no particular order.{% endblocktrans %}
                    {% if request.user == user %}
                        <strong>{% blocktrans %}Please fill in the missing dates on all your images!{% endblocktrans %}</strong>
                    {% endif %}
                </p>
                {% endif %}
                {% image_list request image_list %}
            {% endif %}
        </div>
    </div>

    <a name="stats"></a>
    <div class="plots full-box">
        <h2>{% blocktrans with user.username as user %}{{user}}'s statistics{% endblocktrans %}</h2>
        {% ifequal request.user user %}
        <p>
            {% blocktrans with user.username as user %}Hey <strong>{{user}}</strong>! I just wanted to let you know that you could make these plots more useful if you added all data to your images. Please make sure by checking whether you have images which lack data <a href="?public&sub=nodata">here</a>.{% endblocktrans %}
        </p>
        {% endifequal %}

        <a name="stats_integration_hours_anchor"></a>
        <ul class="bar">
            <li id="menu">
                <ul class="topnav">
                    <li class="first last">
                        <span class="text"><a href="#">{% trans "Show by period" %}</a></span>
                        <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                        <div class="sub">
                            <ul class="subnav">
                                <li><span class="text"><a href="{% query_string "s_ihp='yearly'" "" %}#stats_integration_hours_anchor">{% trans "Yearly" %}</a></span></li>
                                <li><span class="text"><a href="{% query_string "s_ihp='monthly'" "" %}#stats_integration_hours_anchor">{% trans "Monthly" %}</a></span></li>
                                <li><span class="text"><a href="{% query_string "s_ihp='daily'" "" %}#stats_integration_hours_anchor">{% trans "Daily" %}</a></span></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        <div id="stats_integration_hours" class="plot" style="width:880px;height:300px;">
            <div class="loading">
                <p>{% trans "Please wait: the plot is loading..." %}</p>
                <img alt="{% trans "Loading..." %}" src="/static/images/plot-loading.gif" />
            </div>
        </div>

        <a name="stats_uploaded_images_anchor"></a>
        <ul class="bar">
            <li id="menu">
                <ul class="topnav">
                    <li class="first last">
                        <span class="text"><a href="#">{% trans "Show by period" %}</a></span>
                        <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                        <div class="sub">
                            <ul class="subnav">
                                <li><span class="text"><a href="{% query_string "s_uip='yearly'" "" %}#stats_uploaded_images_anchor">{% trans "Yearly" %}</a></span></li>
                                <li><span class="text"><a href="{% query_string "s_uip='monthly'" "" %}#stats_uploaded_images_anchor">{% trans "Monthly" %}</a></span></li>
                                <li><span class="text"><a href="{% query_string "s_uip='daily'" "" %}#stats_uploaded_images_anchor">{% trans "Daily" %}</a></span></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        <div id="stats_uploaded_images" class="plot" style="width:880px;height:300px;">
            <div class="loading">
                <p>{% trans "Please wait: the plot is loading..." %}</p>
                <img alt="{% trans "Loading..." %}" src="/static/images/plot-loading.gif" />
            </div>
        </div>

        <a name="stats_integration_hours_by_gear_anchor"></a>
        <ul class="bar">
            <li id="menu">
                <ul class="topnav">
                    <li class="first last">
                        <span class="text"><a href="#">{% trans "Show by period" %}</a></span>
                        <span class="small-icon"><a href="#"><img alt="" src="/static/icons/iconic/white/menu.png"/></a></span>
                        <div class="sub">
                            <ul class="subnav">
                                <li><span class="text"><a href="{% query_string "s_ihgp='yearly'" "" %}#stats_integration_hours_by_gear_anchor">{% trans "Yearly" %}</a></span></li>
                                <li><span class="text"><a href="{% query_string "s_ihgp='monthly'" "" %}#stats_integration_hours_by_gear_anchor">{% trans "Monthly" %}</a></span></li>
                                <li><span class="text"><a href="{% query_string "s_ihgp='daily'" "" %}#stats_integration_hours_by_gear_anchor">{% trans "Daily" %}</a></span></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        <div id="stats_integration_hours_by_gear" class="plot" style="width:880px;height:300px;">
            <div class="loading">
                <p>{% trans "Please wait: the plot is loading..." %}</p>
                <img alt="{% trans "Loading..." %}" src="/static/images/plot-loading.gif" />
            </div>
        </div>
        <div id="stats_integration_hours_by_gear_legend" class="legend"></div>
    </div>

    <a name="card"></a>
    <div class="user-card full-box clear">
        <h2>{% blocktrans with user.username as username %}{{username}}'s technical card{% endblocktrans %}</h2>
        <div class="gear">
            <h3>{% trans "Gear" %}</h3>
            {% for i in gear_list %}
                <p>
                    <strong>{% trans i.0 %}:&nbsp;</strong>
                    {% for g in i.1 %}
                        {% if i.2 == 'imaging_telescopes' or i.2 == 'imaging_cameras' %}<a href="/search/?q=&as_values_{{i.2}}={{g.id}}">{{g.name|escape}}</a>{% else %}<a href="/search/?q={{g.name|escape}}&type={{i.2}}">{{g.name|escape}}</a>{% endif %}{% if not forloop.last %},{% endif %}
                    {% endfor %}
                </p>
            {% endfor %}
        </div>
        <div class="stats">
            <h3>{% trans "Stats" %}</h3>
            {% for i in stats %}
                {% if i.1 %}<p><strong>{{i.0}}</strong>: {{i.1}}</p>{% endif %}
            {% endfor %}
        </div>
    </div>

    <a name="about"></a>
    <div class="user-about full-box clear">
        <h2>{% blocktrans with user.username as username %}About {{username}}{% endblocktrans %}</h2>
        {% if profile.website %}
        <p><strong>{% trans "Website" %}:</strong> <a href="{{profile.website}}" target="_blank">{{profile.website|safe}}</a></p>
        {% endif %}

        {% if profile.job %}
        <p><strong>{% trans "Job" %}:</strong> {{profile.job|safe}}</p>
        {% endif %}

        {% if profile.hobbies %}
        <p><strong>{% trans "Hobbies" %}:</strong> {{profile.hobbies|safe}}</p>
        {% endif %}

        {% if profile.about %}
        <p><strong>{% trans "About" %}:</strong></p>
        <p>{{profile.about|safe|linebreaks}}</p>
        {% endif %}

        {% if not profile.website and not profile.job and not profile.hobbies and not profile.about %}
            {% ifequal request.user user %}
                <p>
                    {% url profile_edit_basic as the_url %}
                    {% blocktrans %} You have written nothing about yourself. Why don't you <a href="{{the_url}}">do it now?</a>{% endblocktrans %}
                </p>
            {% else %}
                <p>
                    {% blocktrans with user.username as username %}{{username}} didn't write anything about themselves.{% endblocktrans %}
                </p>
            {% endifequal %}
        {% endif %}
    </div>

    {% if request.user == user %}
    <p style="text-align: center"><a href="{% url index %}">{% trans "Go to the homepage to upload a new image!" %}</a></p>

    <noscript>
        <div class="tools-box clear">
            <h2>{% trans "Tools" %}</h2>
            <ul>
                <li>
                    <a href="{% url profile_edit_basic %}">
                        <img src="/static/icons/iconic/orange/edit_profile.png" alt="{% trans "Edit profile" %}"/>
                    </a>
                    <a href="{% url profile_edit_basic %}">
                        {% trans "Edit profile" %}
                    </a>
                </li>
                <li>
                    <a href="{% url auth_logout %}">
                        <img src="/static/icons/iconic/orange/logout.png" alt="{% trans "Logout" %}"/>
                    </a>
                    <a href="{% url auth_logout %}">
                        {% trans "Logout" %}
                    </a>
                </li>
            </ul>
        </div>
    </noscript>
    {% endif %}
</div> <!-- profile -->

{% endblock %}

{% block extra_js %}
<script type="text/javascript">
$(document).ready(function() {
    common.init(
        '{{user.username}}',
        {
            follow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Follow {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will receive a notification every time {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, follow!" %}"
                },
                stop_following: "{% trans "Stop following" %}"
            },
            unfollow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Stop following {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will stop receiving notifications when {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, stop following!" %}"
                },
                follow: "{% trans "Follow" %}"
            },
            message_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Send {{username}} a message{% endblocktrans %}",
                    body  : "",
                    button: "{% trans "Send" %} &rarr;"
                },
                form_html: '{% autoescape off %}{{private_message_form.as_p|append_slash}}{% endautoescape %}',
                csrf_token: '{{csrf_token}}',
                url      : "{% url send_private_message %}"
            }
        });

        stats.init();

        stats.plot(
            '#stats_integration_hours',
            {% if 's_ihp' in request.GET %}
            "{% url stats_integration_hours user.username request.GET.s_ihp 0 %}",
            {% else %}
            "{% url stats_integration_hours user.username 'monthly' 0 %}",
            {% endif %}
            5000);
        stats.enableTooltips("#stats_integration_hours");

        stats.plot(
            '#stats_uploaded_images',
            {% if 's_uip' in request.GET %}
            "{% url stats_uploaded_images user.username request.GET.s_uip %}",
            {% else %}
            "{% url stats_uploaded_images user.username 'monthly' %}",
            {% endif %}
            5000);
        stats.enableTooltips("#stats_uploaded_images");

        $.ajax({
            {% if 's_ihgp' in request.GET %}
                url: "{% url stats_integration_hours_by_gear user.username request.GET.s_ihgp %}",
            {% else %}
                url: "{% url stats_integration_hours_by_gear user.username 'monthly' %}",
            {% endif %}
            method: 'GET',
            dataType: 'json',
            timeout: 60000,
            success: function(series) {
                series['flot_options']['legend']['container'] = $('#stats_integration_hours_by_gear_legend');
                $.plot($('#stats_integration_hours_by_gear'),
                    series['flot_data'],
                    series['flot_options']);
            }
        });
        stats.enableTooltips("#stats_integration_hours_by_gear");
});
</script>
{% endblock %}

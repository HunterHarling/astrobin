{% load url from future %}
{% load i18n pybb_tags %}
<form class="post-form" action="
    {% if forum %}
        {% url 'pybb:add_topic' forum.pk %}
    {% else %}
        {% if topic %}
            {% url 'pybb:add_post' topic.pk %}
        {% else %}
            {% url 'pybb:edit_post' pk=object.pk %}
        {% endif %}
    {% endif %}" method="post" enctype="multipart/form-data">
  {% csrf_token %}
  <fieldset>
    {% include "pybb/form_errors.html" %}
    {% if form.name %} {% include "pybb/form_field.html" with field=form.name %} {% endif %}
    {% if form.slug %} {% include "pybb/form_field.html" with field=form.slug %} {% endif %}
    {% if form.login %} {% include "pybb/form_field.html" with field=form.login %}  {% endif %}
    {% if form.body %} {% include "pybb/form_field.html" with field=form.body %}  {% endif %}

    {% if request.user|pybb_may_create_poll and form.poll_type %}
      {% include "pybb/poll_edit_form.html" %}
    {% endif %}
    {% include "pybb/attachments_formset.html" %}
    <p class="submit">{% include "pybb/_button_submit.html" %}</p>
  </fieldset>
</form>

{% block extra_js %}
    <script type="text/javascript" src="{{STATIC_URL}}markitup/jquery.markitup.js"></script>
    <script type="text/javascript" src="{{STACI_URL}}markitup/sets/bbcode/set.js"></script>
    <script language="javascript">
    $(document).ready(function()	{
        if (window.pybb && window.pybb.get_markitup_settings) {
            (function($) {
                // from http://docs.djangoproject.com/en/1.4/ref/contrib/csrf/#ajax
                function getCookie(name) {
                    var cookieValue = null;
                    if (document.cookie && document.cookie != '') {
                        var cookies = document.cookie.split(';');
                        for (var i = 0; i < cookies.length; i++) {
                            var cookie = $.trim(cookies[i]);
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                var csrftoken = getCookie('csrftoken');

                function csrfSafeMethod(method) {
                    // these HTTP methods do not require CSRF protection
                    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
                }
                $.ajaxSetup({
                    crossDomain: false, // obviates need for sameOrigin test
                    beforeSend: function(xhr, settings) {
                        if (!csrfSafeMethod(settings.type)) {
                            xhr.setRequestHeader("X-CSRFToken", csrftoken);
                        }
                    }
                });
            })(jQuery);

            $('#id_body').markItUp(pybb.get_markitup_settings());

            $('#emoticons a').click(function() {
                emoticon = $(this).attr("title");
                $.markItUp( { replaceWith:emoticon } );
            });
        }
    });
    </script>
{% endblock %}

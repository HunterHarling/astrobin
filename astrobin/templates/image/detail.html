{% extends 'base.html' %}
{% load i18n %}
{% load tags %}
{% load hitcount_tags %}
{% load markup %}
{% load bootstrap_toolkit %}
{% load avatar_tags %}

{% block extra_gaq_push %}
    {% if image.is_wip %}
        _gaq.push(['_setCustomVar', 3, 'Staging Image', 'Yes']);
    {% endif %}
{% endblock %}

{% block title %}AstroBin - {{image.title}} ({{image.user}}){% endblock %}
{% block content %}
    {% if 'plate_solving_started' in request.GET %}
    <div class="alert alert-info">
        <a class="close" data-dismiss="alert">&times;</a>
        <p>{% blocktrans %}Plate-solving has started in the background. It might take a while, so please don't request it again! You will be notified when the job has completed. Thanks!{% endblocktrans %}</p>
    </div>
    {% endif %}

    {% ifequal request.user image.user %}
    {% if image.is_wip %}
    <div class="alert alert-info">
        <p>
        {% url image_promote image.id as promote_url %}
        {% url me as profile_url %}
        {% blocktrans %}This image is a <strong>work in progress</strong> from your <a href="{{profile_url}}?staging">Staging Area</a>. This means nobody can see it unless you give them one of the links you can find in the <em>Share</em> menu below. Use that link to post this image to Internet forums and get feedback on it. When you are satisfied, perhaps after uploading some revisions, <a href="{{promote_url}}">promote it</a> to the <a href="{{profile_url}}">Public Area</a>.{% endblocktrans %}
        </p>
    </div>
    {% endif %}
    {% endifequal %}

    <div class="subnav subnav-fixed">
        <ul class="nav nav-pills">
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    {% trans "Actions" %}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% if request.user == image.user or request.user.is_superuser %}
                    <li>
                        <a href="{% url image_edit_basic image.id %}">
                            <i class="icon-edit"></i>
                            {% trans "Edit basic information" %}
                        </a>
                    </li>
                    <li>
                        <a href="{% url image_edit_gear image.id %}">
                            <i class="icon-edit-gear"></i>
                            {% trans "Edit gear used" %}
                        </a>
                    </li>
                    <li>
                        <a href="{% url image_edit_acquisition image.id %}">
                            <i class="icon-edit-acquisition"></i>
                            {% trans "Edit acquisition details" %}
                        </a>
                    </li>
                    {% if not is_final %}
                    <li>
                        {% if is_revision %}
                        <a href="{% url image_edit_revision_make_final revision_image.id %}">
                        {% else %}
                        <a href="{% url image_edit_make_final image.id %}">
                        {% endif %}
                            <i class="icon-make-final"></i>
                            {% trans "Mark this revision as final" %}
                        </a>
                    </li>
                    {% endif %} <!-- not is_final -->
                    <li class="divider"></li>
                    <li>
                        <a href="{% url image_edit_license image.id %}">
                            <i class="icon-change-license"></i>
                            {% trans "Change license" %}
                        </a>
                    </li>
                    <li>
                        <a class="upload-revision" href="#">
                            <i class="icon-upload"></i>
                            {% trans "Upload new revision" %}
                        </a>
                    </li>
                    {% if not image.is_solved and not is_revision %}
                    <li>
                        <a class="plate-solve" href="{% url image_edit_presolve image.id %}{% query_string "done_later=" "plate_solving_started" %}">
                            <i class="icon-plate-solve"></i>
                            {% trans "Plate-solve" %}
                        </a>
                    </li>
                    {% else %}
                    <li>
                        <a class="plate-solve" href="{% url image_edit_presolve image.id %}{% query_string "done_later=" "plate_solving_started" %}">
                            <i class="icon-plate-solve"></i>
                            {% trans "Plate-solve again" %}
                        </a>
                    </li>
                    {% endif %} <!-- not image.is_solved and not is_revision -->
                    {% if image.is_wip %}
                    <li>
                        <a href="{% url image_promote image.id %}{% query_string "" "plate_solving_started" %}">
                            <i class="icon-promote"></i>
                            {% trans "Promote to public area" %}
                        </a>
                    </li>
                    {% else %}
                    <li>
                        <a href="{% url image_demote image.id %}{% query_string "" "plate_solving_started" %}">
                            <i class="icon-demote"></i>
                            {% trans "Move to staging area" %}
                        </a>
                    </li>
                    {% endif %} <!-- image.is_wip -->
                    <li class="divider"></li>
                    <li>
                    {% if not is_revision %}
                        {% if revisions %}
                        <a class="delete-original danger" href="{% url image_delete_original image.id %}">
                            <i class="icon-delete"></i>
                            {% trans "Delete original image" %}
                        </a>
                        {% else %}
                        <a class="delete-everything danger" href="{% url image_delete image.id %}">
                            <i class="icon-delete"></i>
                            {% trans "Delete everything" %}
                        </a>
                        {% endif %} <!-- revisions -->
                    {% else %}
                        <a class="delete-revision danger" href="{% url image_delete_revision image.id %}">
                            <i class="icon-delete"></i>
                            {% trans "Delete this revision" %}
                        </a>
                    {% endif %} <!-- not is_revision -->
                    </li>
                    {% endif %} <!-- owner or superuser -->
                    <li class="divider"></li>
                    <li>
                        <a href="{% url bring_to_attention image.id %}">
                            <i class="icon-quote"></i>
                            {% trans "Bring to a user's attention" %}
                        </a>
                    </li>
                    {% if request.user != image.user %}
                    <li>
                        <a href="{% url image_request_additional_information image.id %}">
                            <i class="icon-info"></i>
                            {% trans "Request additional information" %}
                        </a>
                    </li>
                    <li>
                        <a href="{% url image_request_fits image.id %}">
                            <i class="icon-file"></i>
                            {% trans "Request TIFF/FITS" %}
                        </a>
                    </li>
                    {% endif %} <!-- not owner -->
                    {% if is_ready %}
                    <li class="divider"></li>
                    <li>
                        <a class="messier-nomination" href="{% url messier_nomination image.id %}">
                            <i class="icon-book"></i>
                            {% trans "Nominate for the Messier Marathon" %}
                        </a>
                    </li>
                    {% endif %} <!-- is_ready -->
                 </ul>
             </li> <!-- actions -->
             <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    {% trans "View" %}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    {% if not inverted and not solved %}
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                <i class="icon-inverted"></i>
                                {% trans "Inverted monochrome" %}
                            </a>
                        </li>
                        {% if image.is_solved and not solved %}
                        <li>
                            {% if is_revision %}
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved', r=0" "plate_solving_started" %}">
                                <i class="icon-solved"></i>
                                {% trans "Annotated (original version)" %}
                            </a>
                            {% else %} <!-- is_revision -->
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved'" "plate_solving_started" %}">
                                <i class="icon-solved"></i>
                                {% trans "Annotated" %}
                            </a>
                            {% endif %} <!-- is_revision -->
                        </li>
                        {% endif %} <!-- is_solved and not showing solved -->
                    {% endif %} <!-- not showing inverted and not showing solved -->

                    {% if inverted %}
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='none'" "plate_solving_started" %}">
                                <i class="icon-normal"></i>
                                {% trans "Normal" %}
                            </a>
                        </li>
                        {% if image.is_solved and not solved %}
                        <li>
                            {% if is_revision %}
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved', r=0" "plate_solving_started" %}">
                                <i class="icon-solved"></i>
                                {% trans "Annotated (original version)" %}
                            </a>
                            {% else %} <!-- is_revision -->
                            <a href="{{image.get_absolute_url}}{% query_string "mod='solved'" "plate_solving_started" %}">
                                <i class="icon-solved"></i>
                                {% trans "Annotated" %}
                            </a>
                            {% endif %} <!-- is_revision -->
                        </li>
                        {% endif %} <!-- is_solved and not showing solved -->
                    {% endif %} <!-- showing inverted -->

                    {% if solved %}
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='none'" "plate_solving_started" %}">
                                <i class="icon-normal"></i>
                                {% trans "Normal" %}
                            </a>
                        </li>
                        <li>
                            <a href="{{image.get_absolute_url}}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                <i class="icon-inverted"></i>
                                {% trans "Inverted monochrome" %}
                            </a>
                        </li>
                    {% endif %} <!-- showing solved -->
                </ul>
            </li> <!-- view -->

            {% if request.user != image.user %}
            <li class="dropdown">
                <a class="dropdown-toggle" data-toggle="dropdown" href="#">
                    {% trans "User" %}
                    <span class="caret"></span>
                </a>
                <ul class="dropdown-menu">
                    <li>
                        <a href="{% url user_page image.user %}">
                            <i class="icon-profile"></i>
                            {% trans "View profile" %}
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                    <li>
                        <a class="{% if follows %}unfollow{% else %}follow{% endif %}"
                           href="{% if follows %}{% url unfollow image.user %}{% else %}{% url follow image.user %}{% endif %}{% query_string "next=request.path" "plate_solving_started" %}">
                            {% if follows %}
                                <i class="icon-unfollow"></i>
                                {% trans "Stop following" %}
                            {% else %}
                                <i class="icon-follow"></i>
                                {% trans "Follow" %}
                            {% endif %}
                        </a>
                    </li>
                    {% endif %} <!-- authenticated -->
                    <li>
                        <a class="send-private-message" href="{% url messages_compose_to image.user.username %}{% query_string "next=request.path, subject=image.title" "" %}">
                            <i class="icon-message"></i>
                            {% trans "Send private message" %}
                        </a>
                    </li>
                </ul>
            </li> <!-- user -->
            {% endif %} <!-- not owner -->

            <li>
                <a data-toggle="modal" href="#share-modal">{% trans "Share" %}</a>
            </li>
        </ul> <!-- nav -->
    </div> <!-- subnav -->

    <div class="row"> <!-- main pane -->
        <div class="span8">
            <div class="row"> <!-- the image's row -->
                <div class="span8">
                    <div class="main-image">
                        <div class="main-image-inner">
                            {% if is_ready %}
                                {% if is_revision %}
                                    {% with revision_image as image %}
                                        {% if inverted %}
                                        <a class="zoomable" href="{% url image_full image.image.id %}{% query_string "r=image.id, mod='inverted'" "plate_solving_started" %}">
                                            <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}{% if not full %}_resized{% endif %}_inverted{{image.original_ext}}" alt="{{image.title|escape}}"/>
                                        </a>
                                        {% endif %}
                                        {% if not inverted and not solved %}
                                        <a class="zoomable" href="{% url image_full image.image.id %}{% query_string "r=image.id" "mod, plate_solving_started" %}">
                                            <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_resized{{image.original_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                        </a>
                                        {% endif %}
                                    {% endwith %}
                                {% else %}
                                    {% if inverted %}
                                        <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                            <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_resized_inverted{{image.original_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                        </a>
                                        {% if image.is_solved and image.plot_is_overlay %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='inverted'" "plate_solving_started" %}">
                                                <img class="plot-overlay" src="http://astrobin_images.{{s3_url}}/{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}" style="left:{{plot_overlay_left}}px"/>
                                            </a>
                                        {% endif %}
                                    {% endif %}

                                    {% if solved %}
                                        {% if image.plot_is_overlay %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_resized{{image.original_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                            </a>
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img class="fixed-plot-overlay" src="http://astrobin_images.{{s3_url}}/{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" style="left:{{plot_overlay_left}}px"/>
                                            </a>
                                        {% else %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}" />
                                            </a>
                                        {% endif %}
                                    {% endif %}

                                    {% if not inverted and not solved %}
                                        <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                            <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_resized{{image.original_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}"/>
                                        </a>
                                        {% if image.is_solved and image.plot_is_overlay %}
                                            <a class="zoomable" href="{% url image_full image.id %}{% query_string "mod='none'" "plate_solving_started" %}">
                                                <img class="plot-overlay" src="http://astrobin_images.{{s3_url}}/{{image.filename}}_solved{{solved_ext}}" alt="{{image.title|escape}}" width="{{resized_size}}" style="left:{{plot_overlay_left}}px"/>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% endif %}
                            {% else %} <!-- not ready -->
                            <div class="alert alert-warning">
                                {% blocktrans %}This image was just uploaded and is still processing. Please try to refresh this page in a few seconds.{% endblocktrans %}
                            </div>
                            {% endif %}
                        </div> <!-- main-image-inner -->
                    </div> <!-- main-image -->
                </div> <!-- span8 -->
            </div> <!-- the image's row -->

            <div class="image-title">
                <div class="row">
                    <div class="span8">
                        <h2 class="image-title">{{image.title|escape|default:_("(no title)")}}</h2>
                    </div>
                </div>

                {% if image.link %}
                <div class="row">
                    <div class="span8">
                        <strong>{% trans "Link" %}</strong>: <a href="{{image.link}}" target="_blank">{{image.link}}</a>
                    </div>
                </div>
                {% endif %}

                {% if image.link_to_fits %}
                <div class="row">
                    <div class="span8">
                        <strong>{% trans "Link to TIFF/FITS" %}</strong>: <a href="{{image.link_to_fits}}" target="_blank">{{image.link_to_fits}}</a>
                    </div>
                </div>
                {% endif %}

                <div class="row">
                    <div class="span8">
                        {% trans "Contains" %}:
                        {% if solar_system_main_subject >= 0 %}
                            <a href="/search/?q=&amp;ssms={{solar_system_main_subject_id}}{% search_form_query %}">{{solar_system_main_subject}}</a>{% if subjects_short %},{% endif %}
                        {% endif %}
                        {% for s in subjects_short %}
                            <a {% if s.oid != -999 %}rel="popover" class="subject-popover" data-load="{% url subject_popover_ajax s.id %}"{% endif %} href="/search/?q={{s.mainId|escape|cut:" "}}{% search_form_query %}">{{s.mainId|escape|cut:"NAME "|lower|capfirst}}</a>{% if not forloop.last %},{% endif %}
                        {% endfor %}
                        {% if subjects_all|length > 10 %}
                            <span id="more-subjects">
                                <span class="hidden">
                                    ,&nbsp;
                                    {% for s in subjects_reminder %}
                                        <a {% if s.oid != -999 %}rel="popover" class="subject-popover" data-load="{% url subject_popover_ajax s.id %}"{% endif %} href="/search/?q={{s.mainId|escape|cut:" "}}{% search_form_query %}">{{s.mainId|escape|cut:"NAME "|lower|capfirst}}</a>{% if not forloop.last %},{% endif %}
                                    {% endfor %}
                                </span>
                                <span class="more">
                                    &#8230;&nbsp; 
                                    <a href="#">
                                        <em>
                                           {% blocktrans with subjects_all|length|add:subjects_limit as number %}and {{number}} more (click to view).{% endblocktrans %}
                                        </em>
                                    </a>
                                </span>
                                <span class="collapse">
                                    <a href="#">
                                        &nbsp;
                                        <em>
                                           {% blocktrans %}(hide these subjects){% endblocktrans %}
                                        </em>
                                    </a>
                                </span>
                            </span>
                        {% endif %}
                    </div> <!-- span8 -->
                </div>
            </div>

            {% if revisions or is_revision %}
            <div class="row">
                <div class="span8">
                    <div class="subtle-container">
                        <h4>
                            {% if is_revision %}
                                {% trans "This image is a revision. Here are its other versions" %}:
                            {% else %}
                                {% trans "This image has some other revisions" %}:
                            {% endif %}
                        </h4>
                        <ul class="thumbnails astrobin-thumbnails">
                            {% if is_revision %}
                            <li class="thumbnail astrobin-thumbnail">
                                <a href="{% url image_detail image.id %}{% query_string "r=0" "plate_solving_started, mod" %}">
                                    <img {% if image.is_final %}style="border: 2px solid white"{% endif %} src="{% if image.is_stored %}http://astrobin_images.{{s3_url}}/{{image.filename}}_small_thumb{{image.original_ext}}{% else %}{{STATIC_URL}}icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="" width="{{small_thumbnail_size}}" height="{{small_thumbnail_size}}"/>
                                </a>
                            </li>
                            {% endif %}
                            {% for i in revisions %}
                            <li class="thumbnail astrobin-thumbnail">
                                <a href="{% url image_detail i.image.id %}{% query_string "r=i.id" "plate_solving_started, mod" %}">
                                    <img {% if i.is_final %}style="border: 2px solid white"{% endif %} src="{% if image.is_stored %}http://astrobin_images.{{s3_url}}/{{i.filename}}_small_thumb{{i.original_ext}}{% else %}{{STATIC_URL}}icons/iconic/orange/waiting_thumbnail_small.png{% endif %}" alt="" width="{{small_thumbnail_size}}" height="{{small_thumbnail_size}}"/>
                                </a>
                            </li>
                            {% endfor %}
                        </ul> <!-- thumbnails -->
                    </div> <!-- subtle-container -->
                </div> <!-- span8 -->
            </div> <!-- row -->
            {% endif %}

            <div class="row image-detail">
                <div class="span8">
                    <div class="subtle-container image-detail-inner">
                        <ul class="nav nav-pills">
                            <li class="active"><a href="#image-pill-card" data-toggle="pill">{% trans "Technical card" %}</a></li>
                            <li><a href="#image-pill-views" data-toggle="pill">{% trans "Views" %}</a></li>
                        </ul>
                        <div class="pill-content">
                            <div class="pill-pane fade in active" id="image-pill-card">
                                <div class="gear">
                                    <div class="gear-inner">
                                        {% for i in gear_list %}
                                            {% if i.1 %}
                                                <p>
                                                  <strong>{% trans i.0 %}:</strong>
                                                  {% for g in i.1 %}
                                                        {% if i.2 == 'imaging_telescopes' or i.2 == 'imaging_cameras' %}
                                                            <a rel="popover" class="gear-popover" data-load="{% url gear_popover_ajax g.id %}" href="/search/?q=&amp;as_values_{{i.2}}={{g.id}}{% search_form_query %}">{{g.name|escape}}</a>
                                                        {% else %}
                                                            <a rel="popover" class="gear-popover" data-load="{% url gear_popover_ajax g.id %}" href="/search/?q={{g.name|escape|urlencode}}&amp;type={{i.2}}{% search_form_query %}">{{g.name|escape}}</a>
                                                        {% endif %}
                                                        {% if not forloop.last %},&nbsp;{% endif %}
                                                    {% endfor %}
                                                </p>
                                            {% endif %}
                                        {% endfor %}
                                        {% if is_ready and not image.animated %}
                                            <div class="image-histogram">
                                                <img src="http://astrobin_images.{{s3_url}}/{{image.filename}}_hist.png" alt="{% trans "Histogram" %}"/>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div> <!-- gear -->
    
                                <div class="acquisition">
                                    <div class="acquisition-inner">
                                        {% if image_type == 'deep_sky' %}
                                            {% for data in deep_sky_data %}
                                                {% if data.1 %}
                                                    <p>
                                                        <strong>{{data.0}}</strong>:
                                                        {% if data.0 == dates_label %}
                                                            {% for date in data.1 %}
                                                                <a href="/search/{% query_string "q=, start_date=date, end_date=date" "plate_solving_started, r, mod" %}{% search_form_query %}">{{date|date:"DATE_FORMAT"}}</a>{% if not forloop.last %},&nbsp;{% endif %}
                                                            {% endfor %}
                                                        {% else %}
                                                            {{data.1|linebreaksbr}}
                                                        {% endif %}
                                                    </p>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            {% if ssa.date %}
                                                <p><strong>{% trans "Date" %}</strong>: <a href="/search/{% query_string "q=, start_date=ssa.date, end_date=ssa.date" "plate_solving_started, r, mod" %}{% search_form_query %}">{{ssa.date|date:"DATE_FORMAT"}}</a></p>
                                            {% endif %}
                                            {% if ssa.time %}
                                                <p><strong>{% trans "Time" %}</strong>: {{ssa.time}}</p>
                                            {% endif %}
                                            {% if ssa.frames %}
                                                <p><strong>{% trans "Frames" %}</strong>: {{ssa.frames}}</p>
                                            {% endif %}
                                            {% if ssa.fps %}
                                                <p><strong>{% trans "FPS" %}</strong>: {{ssa.fps}}</p>
                                            {% endif %}
                                            {% if ssa.focal_length %}
                                                <p><strong>{% trans "Focal length" %}</strong>: {{ssa.focal_length}}</p>
                                            {% endif %}
                                            {% if ssa.cmi %}
                                                <p><strong>{% trans "CMI" %}</strong>: {{ssa.cmi}}</p>
                                            {% endif %}
                                            {% if ssa.cmii %}
                                                <p><strong>{% trans "CMII" %}</strong>: {{ssa.cmii}}</p>
                                            {% endif %}
                                            {% if ssa.cmiii %}
                                                <p><strong>{% trans "CMIII" %}</strong>: {{ssa.cmiii}}</p>
                                            {% endif %}
                                            {% if ssa.seeing %}
                                                <p><strong>{% trans "Seeing" %}</strong>: {{ssa.seeing}}</p>
                                            {% endif %}
                                            {% if ssa.transparency %}
                                                <p><strong>{% trans "Transparency" %}</strong>: {{ssa.transparency}}</p>
                                            {% endif %}
                                        {% endif %}
        
                                        {% if image.is_solved and image.ra_center_hms %}
                                            <p><strong>{% trans "RA center" %}</strong>: {{image.ra_center_hms}}</p>
                                            <p><strong>{% trans "DEC center" %}</strong>: {{image.dec_center_dms}}</p>
                                            {% if image.pixscale != 0 %}
                                                <p><strong>{% trans "Pixel scale" %}</strong>: {{image.pixscale|cut_decimals:"2"}} {% trans "arcsec/pixel" %}</p>
                                            {% endif %}
                                            <p><strong>{% trans "Orientation" %}</strong>: {{image.orientation|cut_decimals:"2"}} {% trans "degrees" %}</p>
                                            <p><strong>{% trans "Field width" %}</strong>: {{image.fieldw|cut_decimals:"2"}} {% if image.fieldunits == 'degrees' %}{% trans "degrees" %}{% else %}{% if image.fieldunits == 'arcminutes' %}{% trans 'arcminutes' %}{% endif %}{% endif %}</p>
                                            <p><strong>{% trans "Field height" %}</strong>: {{image.fieldh|cut_decimals:"2"}} {% if image.fieldunits == 'degrees' %}{% trans "degrees" %}{% else %}{% if image.fieldunits == 'arcminutes' %}{% trans 'arcminutes' %}{% endif %}{% endif %}</p>
                                        {% endif %}
                                    </div> <!-- acquisition-inner -->
                                </div> <!-- acquisition -->
                            </div> <!-- image-pill-card -->
    
                            <div class="pill-pane fade in" id="image-pill-views">
                                <div class="plot" style="width:580px; height: 150px;"></div>
                            </div>
                        </div> <!-- pill-content -->
                    </div> <!-- image-detail-inner -->
                </div> <!-- span8 -->
            </div> <!-- row image-detail -->
                
            {% if image.description %}
            <div class="image-description row">
                <div class="span8">
                    <div class="subtle-container">
                        <h3>{% trans "Description" %}</h3>
                        {{image.description|safe|linebreaks}}
                    </div>
                </div>
            </div>
            {% endif %}
            <div class="row comment-container">
                <div class="span8">
                    <div class="subtle-container">
                        <h3>{% trans "Comments" %}</h3>
                        {% if user.is_authenticated %}
                        <p>
                            {% blocktrans with user=image.user lang=preferred_language %}<strong>Leave a comment here</strong>, and remember that AstroBin is an international community: using English is preferred. PS: <strong>{{user}}</strong>'s preferred language is <strong>{{lang}}</strong>.{% endblocktrans %}
                        </p>
                        <div class="top-level-form">
                            <form class="form-horizontal" action="{% url image_comment_save %}" method="post">
                                {{comment_form|as_bootstrap}}
                                <input type="hidden" name="author" value="{{user.id}}" />
                                <input type="hidden" name="image" value="{{image.id}}" />
                                <input type="hidden" name="parent_id" value="" />
                                <input type="hidden" name="level" value="0" />
                                <div>
                                    <input class="btn btn-mini btn-primary" type="submit" value="{% trans "Save" %}" />
                                    <span class="help-inline">
                                        <a href="{% url faq %}#10" target="_blank">{% trans "Formatting help" %}</a>
                                    </span>
                                    <span class="loader">
                                        <img src="{{STATIC_URL}}images/ajax-loader.gif" alt=""/> 
                                    </span>
                                </div>
                            </form>
                        </div> <!-- top-level-form -->
                        {% else %}
                            <p>
                                {% blocktrans %}Please <a href="/accounts/login/">login</a> or <a href="/accounts/register/">register</a> to leave a comment.{% endblocktrans %}
                            </p>
                        {% endif %}
    
                        {% if comments %}
                            {% load mptt_tags %}
                            {% recursetree comments %}
                                <div style="margin-left: {{node.get_level|add:node.get_level}}em">
                                    <div id="c{{node.id}}" class="comment">
                                        <div class="avatar">
                                            <a href="{% url user_page node.author %}">
                                                {% avatar node.author 32 %}
                                            </a>
                                        </div>
                                        <div class="meta">
                                            <a class="author" href="{% url user_page node.author %}">{{node.author}}</a> {{node.added|ago}}
                                        </div>
                                        <div class="content{% if node.is_deleted %} deleted{% endif %}">
                                            {% if node.is_deleted %}
                                                <p>{% trans "(comment deleted)" %}</p>
                                            {% else %}
                                                {{node.comment|markdown|linebreaks}}
                                            {% endif %}
                                        </div>
                                        <div class="links">
                                            <a class="permalink" href="{% url image_detail image.id %}#c{{node.id}}">{% trans "Link" %}</a>
                                            {% if user.is_authenticated %}
                                                {% if user == node.author %}
                                                    <a class="delete" href="#">
                                                        {% if node.is_deleted %}
                                                            {% trans "Undelete" %}
                                                        {% else %}
                                                            {% trans "Delete" %}
                                                        {% endif %}
                                                    </a>
                                                    <a class="edit" href="#">{% trans "Edit" %}</a>
                                                {% endif %}
                                                <a class="reply" href="#">{% trans "Reply" %}</a>
                                            {% endif %}
                                        </div>
                                        <form action="{% url image_comment_save %}" method="post">
                                            {{comment_form.as_p}}
                                            <input type="hidden" name="author" value="{{user.id}}" />
                                            <input type="hidden" name="image" value="{{image.id}}" />
                                            <input type="hidden" name="parent_id" value="{{node.id}}" />
                                            <input type="hidden" name="level" value="{{node.get_level}}" />
                                            <p>
                                                <input class="btn btn-mini btn-primary" type="submit" value="{% trans "Save" %}" />
                                                <input class="btn btn-mini cancel" type="reset" value="{% trans "Cancel" %}" />
                                                <span class="formatting-help">
                                                    <a href="{% url faq %}#10" target="_blank">{% trans "Formatting help" %}</a>
                                                </span>
                                                <span class="loader">
                                                    <img src="{{STATIC_URL}}images/ajax-loader.gif" alt=""/> 
                                                </span>
                                            </p>
                                        </form>
                                    </div>
                                </div>
                                {% if not node.is_leaf_node %}
                                    {{children}}
                                {% endif %}
                            {% endrecursetree %}
                        {% else %}
                            <div class="no-comments-yet">
                                {% blocktrans %}There are no comments yet.{% endblocktrans %}
                            </div>
                        {% endif %}
                    </div> <!-- subtle-container -->
                </div> <!-- span8 -->
            </div> <!-- row  comments-->
        </div> <!-- span8 -->
        
        <div class="span4"> <!-- right pane -->
            <div class="subtle-container avatar-block">
                <div class="avatar">
                    <a href="{% url user_page image.user %}">
                        {% avatar image.user 64 %}
                    </a>
                </div>
                <div class="username">
                    <a rel="tooltip" title="{{image.user.username}}" href="{% url user_page image.user %}">{{image.user.username|truncatechars:18}}</a>
                </div>
            </div>

            <div class="subtle-container">
                <div class="favorite-container">
                    <a href="#" class="favorite" rel="tooltip" title="{% if already_favorited %}{% trans "Already favorited" %}{% else %}{% trans "Mark as favorite" %}{% endif %}">
                        {% if already_favorited %}
                            <img src="{{STATIC_URL}}icons/iconic/red/heart_fill_24x21.png" alt="{% trans "Favorited" %}"/>
                        {% else %}
                            <img src="{{STATIC_URL}}icons/iconic/white/heart_fill_24x21.png" alt="{% trans "Favorite" %}"/>
                        {% endif %}
                    </a>
                </div>

                {% if image.allow_rating %}
                    <div id="rating"></div>
                {% endif %}

            </div> <!-- subtle-container -->

            <div class="subtle-container image-basic-data">
                <table class="table">
                    <tr>
                        <td><img alt="{% trans "License" %}" src="{{STATIC_URL}}icons/iconic/white/key_stroke_16x16.png"/></td>
                        <td>
                            <a target="_blank" href="http://creativecommons.org/licenses/">
                                <img class="license"
                                     src="{{STATIC_URL}}icons/{{license_icon}}"
                                     alt="{% trans "License" %}: {{license_title}}"
                                     title="{% trans "License" %}: {{license_title}}" />
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td><img alt="{% trans "Date" %}" src="{{STATIC_URL}}icons/iconic/white/calendar_alt_stroke_16x16.png"/></td>
                        <td>{{uploaded_on|ago}}</td>
                    </tr>
                    <tr>
                        {% get_hit_count for image as hit_count %}
                        <td><img alt="{% trans "Views" %}" src="{{STATIC_URL}}icons/iconic/white/image_16x16.png"/></td>
                        <td>{{hit_count}}</td>
                    </tr>
                    <tr>
                        <td><img alt="{% trans "Favorites" %}" src="{{STATIC_URL}}icons/iconic/white/heart_stroke_16x14.png"/></td>
                        <td>{{times_favorited}}</td>
                    </tr>
                    <tr>
                        <td><img alt="{% trans "Votes" %}" src="{{STATIC_URL}}icons/iconic/white/star_16x16.png"/></td>
                        <td>{{votes_number}}</td>
                    </tr>
                </table>
            </div>
        </div> <!-- span -->
    </div> <!-- row  (main pane) -->
    
    <div class="modal hide fade" id="share-modal">
        <div class="modal-header">
            <a class="close" data-dismiss="modal">&times;</a>
            <h3>{% trans "Share" %}</h3>
        </div>
        <div class="modal-body">
            <div class="well">
                <span class='st_googleplus' displayText='Google+'></span>
                <span class='st_facebook' displayText='Facebook'></span>
                <span class='st_twitter' displayText='Twitter'></span>
            </div>
            
            <div class="well">
                <form class="copy">
                    <table class="table">
                        <tr>
                            <td>
                                <label for="sharing_mode">{% trans "Sharing mode" %}:</label>
                                <select id="sharing_mode" name="sharing_mode">
                                    <option selected="selected" value="0">{% trans "Simple link" %}</option>
                                    <option value="1">{% trans "Forums" %}</option>
                                    <option value="2">HTML</option>
                                </select>
                            </td>
                            <td>
                                <label for="sharing_thumbnail">{% trans "Thumbnail" %}:</label>
                                <select id="sharing_thumbnail" name="sharing_thumbnail" disabled="disabled">
                                    <option selected="selected" value="0">{% trans "Yes" %}</option>
                                    <option value="1">{% trans "No" %}</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="sharing_image_size">{% trans "Image size" %}:</label>
                                <select id="sharing_image_size" name="sharing_image_size">
                                    <option selected="selected" value="0">{% trans "Regular" %}</option>
                                    <option value="1">{% trans "Full" %}</option>
                                </select>
                            </td>
                            <td rowspan=2>
                                <label for="sharing_code">{% trans "Copy this" %}</label>
                                <div id="clip-container">
                                    <div id="clip" class="clip">
                                        <img alt="{% trans "Copy" %}" src="{{STATIC_URL}}icons/copy.png" />&nbsp;&nbsp;&nbsp;&nbsp;
                                    </div>
                                    <div class="flash-container"></div>
                                    <div class="clip-status">{% trans "Copy" %}</div>
                                </div>
                                <textarea id="sharing_code" name="sharing_code" rows=6>{% if is_revision %}http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}{% else %}http://astrob.in/{{image.id}}/{% endif %}</textarea>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <label for="sharing_image_mode">{% trans "Image mode" %}:</label>
                                <select id="sharing_image_mode" name="sharing_image_mode">
                                    <option selected="selected" value="0">{% trans "Normal" %}</option>
                                    <option value="1">{% trans "Inverted monochrome" %}</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="{{STATIC_URL}}js/jquery.raty.js"></script>
<script type="text/javascript">var switchTo5x=true;</script>
<script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
<script type="text/javascript">stLight.options({publisher: "ur-15649ecb-6f21-a004-8032-7cf8416c478c"}); </script>
<script type="text/javascript">
$(document).ready(function() {
    $('a.favorite').click(function() {
        var $link = $(this),
            $heart = $link.find('img');

        $.ajax({
            url: '{% url favorite_ajax image.id %}',
            dataType: 'json',
            timeout: 5000,
            success: function(data, textStatus, XMLHttpRequest) {
                $heart.attr('src', '{{STATIC_URL}}icons/iconic/red/heart_fill_24x21.png');
                $link.attr('title', "{% trans "Favorited!" %}");
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
            }
        });

        return false;
    });

    var clip = new ZeroClipboard.Client();
    clip.setCSSEffects(false);

    clip.addEventListener('mouseOver', function() {
        $('.clip-status').show();
    });
    clip.addEventListener('mouseOut', function() {
        $('.clip-status').hide();
        $('.clip-status').text('{% trans "Copy" %}');
    });
    clip.addEventListener('complete', function() {
        $('.clip-status').text('{% trans "Copied!" %}');
    });

    clip.setText(
        {% if is_revision %}
            "http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}"
        {% else %}
            "http://astrob.in/{{image.id}}/"
        {% endif %}
    );
    
    var clip_html = clip.getHTML(16, 16);
    $('#clip-container .flash-container').append(clip_html);

    $('form.copy select').change(function() {
        var sharing_mode = parseInt($('select[name=sharing_mode] option:selected').val());
        var image_size = parseInt($('select[name=sharing_image_size] option:selected').val());
        var image_mode = parseInt($('select[name=sharing_image_mode] option:selected').val());
        var thumbnail = parseInt($('select[name=sharing_thumbnail] option:selected').val());
        var textarea = $('form.copy textarea');
        var content = '';

        if (sharing_mode == 0) {
            $('select[name=sharing_thumbnail]').attr('disabled', 'disabled'); 
            $('select[name=sharing_thumbnail]').closest('.selector').addClass('disabled');
        } else {
            $('select[name=sharing_thumbnail]').removeAttr('disabled'); 
            $('select[name=sharing_thumbnail]').closest('.selector').removeClass('disabled');
        }

        if (sharing_mode == 0 && image_size == 0 && image_mode == 0) {
            content =
                {% if is_revision %}
                    "http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}"
                {% else %}
                    "http://astrob.in/{{image.id}}/"
                {% endif %}
        } else
        if (sharing_mode == 0 && image_size == 0 && image_mode == 1) {
            content =
                {% if is_revision %}
                    "http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted"
                {% else %}
                    "http://astrob.in/{{image.id}}/?mod=inverted"
                {% endif %}
        } else
        if (sharing_mode == 0 && image_size == 1 && image_mode == 0) {
            content =
                {% if is_revision %}
                    "http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}"
                {% else %}
                    "http://astrob.in/full/{{image.id}}/"
                {% endif %}
        } else
        if (sharing_mode == 0 && image_size == 1 && image_mode == 1) {
            content =
                {% if is_revision %}
                    "http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted"
                {% else %}
                    "http://astrob.in/full/{{image.id}}/?mod=inverted"
                {% endif %}
        } else

        if (sharing_mode == 1 && image_size == 0 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 0 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/?mod=inverted][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/?mod=inverted][IMG]http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png[/IMG][/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 0 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}]{{image.title}}[/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/]{{image.title}}[/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 0 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted]{{image.title}}[/URL]"
                {% else %}
                    "[URL=http://astrob.in/{{image.id}}/?mod=inverted]{{image.title}}[/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}]{{image.title}}[/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/]{{image.title}}[/URL]"
                {% endif %}
        } else
        if (sharing_mode == 1 && image_size == 1 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "[URL=http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted]{{image.title}}[/URL]"
                {% else %}
                    "[URL=http://astrob.in/full/{{image.id}}/?mod=inverted]{{image.title}}[/URL]"
                {% endif %}
        } else

        if (sharing_mode == 2 && image_size == 0 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 0 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/?mod=inverted\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/><a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 0 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 1 && thumbnail == 0) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/?mod=inverted\"><img src=\"http://astrobin_images.{{s3_url}}/{{image.filename}}_thumb.png\"/></a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 0 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}\">{{image.title}}</a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/\">{{image.title}}</a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 0 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted\">{{image.title}}</a>"
                {% else %}
                    "<a href=\"http://astrob.in/{{image.id}}/?mod=inverted\">{{image.title}}</a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 0 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}\">{{image.title}}</a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/\">{{image.title}}</a>"
                {% endif %}
        } else
        if (sharing_mode == 2 && image_size == 1 && image_mode == 1 && thumbnail == 1) {
            content =
                {% if is_revision %}
                    "<a href=\"http://astrob.in/full/{{revision_image.image.id}}/?r={{revision_image.id}}&mod=inverted\">{{image.title}}</a>"
                {% else %}
                    "<a href=\"http://astrob.in/full/{{image.id}}/?mod=inverted\">{{image.title}}</a>"
                {% endif %}
        }


        clip.setText(content);
        textarea.val(content);
    });

    {% get_hit_count_javascript for image %}

    var hilighted_comment = location.hash.substr(1);
    if (hilighted_comment) {
        $('#' + hilighted_comment).addClass('hilight');
    }

    var ajaxFormOptions = {
        dataType: 'json',
        timeout: 5000,
        beforeSubmit: function(formData, $form, options) {
            $loader = $form.find('.loader');
            $button = $form.find('.btn:first-child');
            $textarea = $form.find('textarea');

            if ($textarea.val() == '')
                return false;

            $button.attr('disabled', 'disabled').addClass('disabled');
            $loader.css('visibility', 'visible');
        },
        success: function(responseJson, statusText, xhr, $form) {
            var $loader = $form.find('.loader');
            var $button = $form.find('.btn:first-child');

            $button.removeAttr('disabled').removeClass('disabled');
            $loader.css('visibility', 'hidden');

            if (responseJson.action == 'save') {
                var $textarea = $form.find('textarea');
                if ($form.parent().hasClass('top-level-form')) {
                    var $parent = $('.top-level-form');
                    var is_top_level = true;
                    var level = 0;
                } else {
                    var $parent = $form.closest('.comment').parent();
                    var is_top_level = false;
                    var level = parseInt($form.find('input:hidden[name="level"]').val()) + 1;
                }
                var parent_id = responseJson['comment_id']
                var $nocomments = $('.no-comments-yet');

                $container = $('<div/>').css('margin-left', level*2 + 'em');
                $new_comment = $('<div/>').addClass('comment').attr('id', 'c' + parent_id);
                $container.append($new_comment);

                $meta = $('<div/>').addClass('meta');
                $author = $('<a/>').attr('href', '{% url user_page user %}').addClass('author').text('{{user.username}}');
                $meta.append($author).append("{% trans "just now" %}");

                $links = $('<div/>').addClass('links');
                $permalink = $('<a/>').addClass('permalink').attr('href', '{% url image_detail image.id %}#c' + parent_id).text('{% trans "Link" %}');
                $delete = $('<a/>').addClass('delete').attr('href', '#').text('{% trans "Delete" %}');
                $edit = $('<a/>').addClass('edit').attr('href', '#').text('{% trans "Edit" %}');
                $reply = $('<a/>').addClass('reply').attr('href', '#').text('{% trans "Reply" %}');

                $links.append($permalink).append($delete).append($edit).append($reply);

                var converter = Markdown.getSanitizingConverter();
                $content = $('<div/>').addClass('content').append($('<p/>').html(converter.makeHtml($textarea.val()).replace(/\n\r?/g, '<br />')));

                new_form_template = "\
                    <form action=\"{% url image_comment_save %}\" method=\"post\">\
                        {{comment_form.as_p|escapejs}}\
                        <input type=\"hidden\" id=\"csrfmiddlewaretoken\" name=\"csrfmiddlewaretoken\" value=\"{{csrf_token}}\" />\
                        <input type=\"hidden\" name=\"author\" value=\"{{user.id}}\" />\
                        <input type=\"hidden\" name=\"image\" value=\"{{image.id}}\" />\
                        <input type=\"hidden\" name=\"parent_id\" value=\"" + parent_id + "\" />\
                        <input type=\"hidden\" name=\"level\" value=\"" + level + "\" />\
                        <p>\
                            <input class=\"btn btn-mini btn-primary\" type=\"submit\" value=\"{% trans "Save" %}\" />\
                            <input class=\"btn btn-mini cancel\" type=\"reset\" value=\"{% trans "Cancel" %}\" />\
                            <span class=\"loader\">\
                                <img src=\"{{STATIC_URL}}images/ajax-loader.gif\" alt=\"\"/>\
                            </span>\
                            <span class=\"formatting-help\">\
                                <a href=\"{% url faq %}#10\" target=\"_blank\">{% trans "Formatting help" %}</a>\
                            </span>\
                        </p>\
                    </form>"

                $new_form = $(new_form_template);
                $new_form.ajaxForm(ajaxFormOptions);

                $new_comment.append($meta)
                            .append($content)
                            .append($links)
                            .append($new_form);

                $textarea.val('');
                if (!is_top_level)
                    $form.hide();

                $nocomments.remove();
                $container.insertAfter($parent);
            }
            else if (responseJson.action == 'edit') {
                var $comment = $form.closest('.comment');
                var $content = $comment.find('.content');
                var $links = $comment.find('.links');

                var converter = Markdown.getSanitizingConverter();
                $content.html($('<div/>').addClass('content').append($('<p/>').html(converter.makeHtml(responseJson.comment).replace(/\n\r?/g, '<br />'))));
                $content.show();
                $links.show();

                $form.hide();
            }
        }
    };

    $('.top-level-form form, .comment form').ajaxForm(ajaxFormOptions);
    $('.comment form .cancel').live('click', function() {
        var $comment = $(this).closest('.comment');
        var $content = $comment.find('.content');
        var $links = $comment.find('.links');
        var $form = $(this).closest('form');

        $form.hide();
        $content.show();
        $links.show();

        return false;
    });

    $('.comment .permalink').live('click', function() {
        var id = $(this).closest('.comment').find('input:hidden[name="parent_id"]').val()
        $('.comment.hilight').removeClass('hilight');
        $('#c' + id).addClass('hilight');
        return true;
    });

    $('.comment .delete').live('click', function() {
        var id = $(this).closest('.comment').find('input:hidden[name="parent_id"]').val()
        var $content = $(this).closest('.comment').find('> .content');
        var $self = $(this);

        $.ajax({
            url: '/image_comments/delete/' + id + '/',
            dataType: 'json',
            timeout: 5000,
            success: function(data, status, xhr) {
                if (data.deleted) {
                    $content.addClass('deleted');
                    $content.html('<p>{% trans "(comment deleted)" %}</p>');
                    $self.text('{% trans 'Undelete' %}');
                } else {
                    var converter = Markdown.getSanitizingConverter();

                    $content.removeClass('deleted');
                    $content.html(converter.makeHtml(data.comment).replace(/\n\r?/g, '<br />'));
                    $self.text('{% trans 'Delete' %}');
                }
            }
        });
        return false;
    });

    $('.comment .edit').live('click', function() {
        var $comment = $(this).closest('.comment');
        var $content = $comment.find('.content');
        var $links = $comment.find('.links');
        var $form = $comment.find('form');
        var $textarea = $form.find('textarea');
        var id = $form.find('input:hidden[name="parent_id"]').val()

        $.ajax({
            url: '/image_comments/get/' + id + '/',
            dataType: 'json',
            timeout: 5000,
            success: function(data, status, xhr) {
                $content.hide();
                $links.hide();
                $textarea.val(data.comment);
                $form.attr('action', '{% url image_comment_edit %}');
                $form.show();
            }
        });

        return false;
    });

    $('.comment .reply').live('click', function() {
        var $comment = $(this).closest('.comment');
        var $form = $comment.find('form');
        var $textarea = $form.find('textarea');

        $form.attr('action', '{% url image_comment_save %}');
        $textarea.val('');
        $form.show();
        $textarea.focus();

        return false;
    });

    astrobin_common.init(
        '{{image.user.username}}',
        {
            follow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Follow {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will receive a notification every time {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, follow!" %}"
                },
                stop_following: "{% trans "Stop following" %}"
            },
            unfollow_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Stop following {{username}}?{% endblocktrans %}",
                    body  : "{% blocktrans with image.user.username as username %}You will stop receiving notifications when {{username}} posts a new image. Continue?{% endblocktrans %}",
                    button: "{% trans "Yes, stop following!" %}"
                },
                follow: "{% trans "Follow" %}"
            },
            message_action: {
                dialog: {
                    title : "{% blocktrans with image.user.username as username %}Send {{username}} a message{% endblocktrans %}",
                    body  : "",
                    button: "{% trans "Send" %} &rarr;"
                },
                form_html: '{% autoescape off %}{{private_message_form.as_p|append_slash}}{% endautoescape %}',
                csrf_token: '{{csrf_token}}',
                url      : "{% url send_private_message %}"
            }
        });

    astrobin_common.setup_gear_popovers('{% trans "Follow" %}', '{% trans "Unfollow" %}');
    astrobin_common.setup_subject_popovers('{% trans "Follow" %}', '{% trans "Unfollow" %}');

    astrobin_image_detail.init(
        {{image.id}},
        {% if is_revision %}{{revision_image.id}}{% else %}0{% endif %},
        "{{image.user.username}}",
        "{{current_rating}}",
        {
            rating: {
                {% if already_voted %}
                hint_list: [
                    {{current_rating}},
                    {{current_rating}},
                    {{current_rating}},
                    {{current_rating}},
                    {{current_rating}}],
                {% else %}
                hint_list: [
                    "{% trans "Bad" %}",
                    "{% trans "Poor" %}",
                    "{% trans "Regular" %}",
                    "{% trans "Good" %}",
                    "{% trans "Gorgeous" %}"],
                {% endif %}
                read_only: {% if request.user.is_authenticated and not already_voted %} false {% else %} true {% endif %}
            },
            upload_revision_action: {
                dialog: {
                    title: "{% trans "Upload new revision" %}",
                    body : "{% blocktrans %}Did you improve the post-processing of your image? Upload the new revision!{% endblocktrans %}"
                },
                form_html: '{% autoescape off %}{{upload_revision_form.file}}\
                            <input class="btn btn-primary" type="submit" value="{% trans "Upload" %}" />\
                            {% endautoescape %}',
                csrf_token: '{{csrf_token}}',
                fileDefaultText: "{% trans "No file selected" %}",
                fileBtnText: "{% trans "Choose file" %}",
                uploadingText: "{% trans "Uploading..." %}"
            },
            delete_action: {
                dialog: {
                    title : "{% trans "Delete image and all its revisions?" %}",
                    body  : "{% trans "The image will be permanently deleted and cannot be recovered. All its revisions will be deleted too. Are you sure?"%}",
                    button: "{% trans "Yes, delete everything" %}"
                }
            },
            delete_revision_action: {
                dialog: {
                    title : "{% trans "Delete this revision?" %}",
                    body  : "{% trans "This revision will be permanently deleted and cannot be recovered. Are you sure?"%}",
                    button: "{% trans "Yes, delete revision" %}"
                }
            },
            delete_original_action: {
                dialog: {
                    title : "{% trans "Delete original image?" %}",
                    body  : "{% trans "The image will be permanently deleted and cannot be recovered. Its revisions will not be deleted. Are you sure?"%}",
                    button: "{% trans "Yes, delete image" %}"
                }
            }
        });

        astrobin_stats.init();
        astrobin_stats.plot(
            '#image-pill-views .plot',
            '{% url stats_image_views image.id 'daily' %}',
            5000);
        astrobin_stats.enableTooltips('#views .plot');
    });
</script>
{% endblock %}

